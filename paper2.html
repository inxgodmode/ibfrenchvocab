<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá´üá∑ IB Listening: Exam Mode (Final)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --bg: #f3f4f6;
            --card: #ffffff;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text: #1f2937;
            --correct: #22c55e;
            --wrong: #ef4444;
            --border: #e5e7eb;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 850px; background: var(--card); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid var(--border); padding: 40px; }
        
        /* Header */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .badge { background: #e0e7ff; color: var(--primary); padding: 5px 12px; border-radius: 8px; font-weight: bold; font-family: monospace; }

        /* Audio */
        .audio-box { background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border); margin-bottom: 30px; }
        audio { width: 100%; margin-top: 10px; height: 40px; }
        .track-title { font-size: 1.4em; font-weight: 800; color: var(--text); }

        /* Questions */
        .q-block { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
        .q-header { display: flex; gap: 12px; margin-bottom: 15px; }
        .q-num { background: var(--text); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .q-text { font-weight: 600; font-size: 1.1em; }
        .q-tag { font-size: 0.75em; text-transform: uppercase; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; height: fit-content; font-weight: bold; }

        /* Inputs */
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px #e0e7ff; }

        /* MCQ & TF */
        .mcq-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .mcq-opt { padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 500; background: white; }
        .mcq-opt:hover { background: #f9fafb; border-color: var(--primary); }
        .mcq-opt.selected { background: #e0e7ff; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .mcq-opt.correct { background: #dcfce7 !important; border-color: var(--correct) !important; color: #14532d; }
        .mcq-opt.wrong { background: #fee2e2 !important; border-color: var(--wrong) !important; color: #7f1d1d; opacity: 0.6; }

        /* Matching */
        .match-grid { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .match-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; align-items: center; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; width: 100%; background: white; }

        /* Footer */
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); text-align: right; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px 30px; font-size: 1.1em; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }

        .feedback { margin-top: 15px; padding: 12px; border-radius: 8px; font-weight: 600; display: none; }
        .feedback.good { background: #dcfce7; color: #15803d; }
        .feedback.bad { background: #fee2e2; color: #b91c1c; }

        .hidden { display: none !important; }
        
        /* Stats */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.8em; font-weight: 900; color: var(--primary); display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div id="intro" class="container" style="text-align: center; padding: 80px;">
        <h1 style="color:var(--primary); font-size: 2.5em; margin-bottom: 10px;">Examen d'√âcoute IB</h1>
        <p style="color: #6b7280; font-size: 1.2em;">Simulation Compl√®te ‚Ä¢ B1/B2</p>
        <button class="btn" style="margin-top: 30px;" onclick="startExam()">COMMENCER LE TEST</button>
    </div>

    <!-- EXAM UI -->
    <div id="exam-ui" class="container hidden">
        <div class="top-bar">
            <span>Piste <span id="track-idx">1</span> / 3</span>
            <span class="badge" id="timer">00:00</span>
        </div>

        <div class="audio-box">
            <div class="track-title" id="track-title">...</div>
            <audio id="player" controls controlsList="nodownload"><source id="audio-src" src="" type="audio/mpeg"></audio>
        </div>

        <div id="q-container">
            <!-- Questions injected here -->
        </div>

        <div class="footer">
            <button class="btn" id="next-btn" onclick="checkAnswers()">Valider & Suivant</button>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="container hidden" style="text-align: center;">
        <h1 style="color: var(--primary);">R√©sultats</h1>
        <div style="font-size: 5em; font-weight: 900; color: #111827;" id="final-score">0/0</div>
        
        <div class="stat-grid">
            <div class="stat-card"><span>Pr√©cision</span><span class="stat-val" id="res-acc">0%</span></div>
            <div class="stat-card"><span>Temps Total</span><span class="stat-val" id="res-time">00:00</span></div>
            <div class="stat-card"><span>Faiblesse</span><span class="stat-val" id="res-weak" style="color:var(--wrong); font-size:1.2em;">-</span></div>
            <div class="stat-card"><span>Temps/Piste</span><span class="stat-val" id="res-avg">0s</span></div>
        </div>

        <p id="api-status" style="color:#6b7280;">Sauvegarde...</p>
        <button class="btn" style="background:#374151;" onclick="location.reload()">Nouveau Test</button>
    </div>

    <script>
        // =========================================================
        // üìö DATABASE
        // =========================================================
        const database = [
            {
                title: "1. S√©rie 'Berlin' (Netflix)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/berlin.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "De quelle s√©rie 'Berlin' est-elle le spin-off ?", o: ["Lupin", "La Casa de Papel", "Elite"], a: 1 },
                    { t: 'tf', cat: 'detail', q: "L'histoire se d√©roule apr√®s la mort de Berlin.", a: false, expl: "C'est un pr√©quel (avant)." },
                    { t: 'input', cat: 'detail', q: "Dans quelle capitale europ√©enne l'action se situe-t-elle ?", a: "Paris" },
                    { t: 'num', cat: 'num', q: "Quelle est la valeur du butin (en millions d'euros) ?", a: "44" },
                    { t: 'num', cat: 'num', q: "De combien de villes proviennent les joyaux ?", a: "34" },
                    { t: 'tf', cat: 'global', q: "La s√©rie est plus violente que la s√©rie originale.", a: false, expl: "Moins violente, plus romantique." },
                    { t: 'mcq', cat: 'detail', q: "En combien de temps le braquage doit-il √™tre fait ?", o: ["Une semaine", "Une seule soir√©e", "Trois jours"], a: 1 },
                    { t: 'input', cat: 'num', q: "Quel mois la s√©rie est-elle sortie (2024) ?", a: "janvier" },
                    { t: 'match', cat: 'detail', q: "Associez les √©l√©ments :", p: {"Andr√®s": "Berlin", "Lieu": "Bijouterie", "Genre": "Romantique"} }
                ]
            },
            {
                title: "2. H√¥tel de la Marine",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/constantin_l_hotel_de_la_marine_a_paris.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Sur quelle place se situe le monument ?", o: ["Bastille", "Concorde", "Vend√¥me"], a: 1 },
                    { t: 'input', cat: 'num', q: "En quelle ann√©e a-t-il ouvert au public ?", a: "2021" },
                    { t: 'input', cat: 'num', q: "De quel si√®cle date la construction ?", a: "18" },
                    { t: 'tf', cat: 'detail', q: "Avant la R√©volution, c'√©tait le Minist√®re de la Marine.", a: false, expl: "C'√©tait le Garde-Meuble du Roi." },
                    { t: 'mcq', cat: 'detail', q: "Pourquoi a-t-on nettoy√© les fa√ßades ?", o: ["√Ä cause des graffitis", "√Ä cause de la pollution", "Pour changer la couleur"], a: 1 },
                    { t: 'match', cat: 'detail', q: "Associez les lieux :", p: {"Salle de Bal": "Galerie des Glaces", "Appartements": "Intendant", "Loggia": "Vue sur la place"} },
                    { t: 'tf', cat: 'global', q: "Le narrateur a appr√©ci√© l'audioguide.", a: false, expl: "Il l'a trouv√© g√™nant." },
                    { t: 'mcq', cat: 'detail', q: "Qui recevait des invit√©s dans ce b√¢timent ?", o: ["Le Pr√©sident de la R√©publique", "Napol√©on", "Le Maire"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Quel est l'h√¥tel de luxe situ√© √† c√¥t√© ?", a: "crillon" }
                ]
            },
            {
                title: "3. Le Puy du Fou",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/puy_du_fou.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quel d√©partement se trouve le parc ?", a: "Vend√©e" },
                    { t: 'num', cat: 'num', q: "Quel est le prix du billet adulte (en ‚Ç¨) ?", a: "44" },
                    { t: 'num', cat: 'num', q: "Le parc est ouvert de 9h30 √† ___ h 30.", a: "22" },
                    { t: 'tf', cat: 'detail', q: "Le spectacle 'Le Mime et l'√âtoile' est en couleur.", a: false, expl: "Il est en noir et blanc." },
                    { t: 'match', cat: 'detail', q: "Associez :", p: {"Vikings": "Drakkars", "Verdun": "Tranch√©es", "Signe du Triomphe": "Gladiateurs"} },
                    { t: 'mcq', cat: 'detail', q: "Combien d'oiseaux participent au 'Bal des Oiseaux Fant√¥mes' ?", o: ["Une dizaine", "Une cinquantaine", "Une centaine"], a: 2 },
                    { t: 'tf', cat: 'global', q: "L'√©l√®ve a eu peur pendant le spectacle de Verdun.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Que font les drakkars des Vikings ?", o: ["Ils volent", "Ils surgissent de l'eau", "Ils br√ªlent"], a: 1 },
                    { t: 'input', cat: 'detail', q: "Quelle course voit-on dans le 'Signe du Triomphe' ? Une course de ___.", a: "chars" }
                ]
            },
            {
                title: "4. Match de Football",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/stephane_un_beau_match_de_foot.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Quelles √©quipes s'affrontaient ?", o: ["PSG vs Bayern", "Manchester City vs Real Madrid", "Chelsea vs Barcelone"], a: 1 },
                    { t: 'num', cat: 'num', q: "Quelle √©tait la date du match (jour et mois) ?", a: "26 avril" },
                    { t: 'mcq', cat: 'detail', q: "√Ä quel stade de la comp√©tition ?", o: ["Finale", "Demi-finale", "Match de poule"], a: 1 },
                    { t: 'input', cat: 'detail', q: "Quel joueur fran√ßais a marqu√© deux buts ?", a: "Benzema" },
                    { t: 'tf', cat: 'detail', q: "Le match √©tait tr√®s violent avec beaucoup de fautes.", a: false, expl: "Tr√®s peu de fautes." },
                    { t: 'mcq', cat: 'global', q: "Pourquoi le narrateur aime les clubs anglais ?", o: ["Ils jouent vite / Espace", "Ils ont de l'argent", "Ils d√©fendent bien"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Les joueurs couraient beaucoup ensemble (pressing).", a: true },
                    { t: 'input', cat: 'num', q: "Combien de buts Benzema a-t-il marqu√©s ?", a: "2" },
                    { t: 'mcq', cat: 'global', q: "Pour les spectateurs, ce match √©tait un...", o: ["Ennui", "R√©gal", "D√©sastre"], a: 1 }
                ]
            },
            {
                title: "5. Souvenirs de Guerre (Caen)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombes_caen.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quelle ville normande se passe l'histoire ?", a: "Caen" },
                    { t: 'num', cat: 'num', q: "Quelle diff√©rence d'√¢ge avec sa s≈ìur ?", a: "6" },
                    { t: 'input', cat: 'num', q: "Quel √¢ge avait la narratrice environ ?", a: "6" },
                    { t: 'mcq', cat: 'detail', q: "O√π la m√®re cachait-elle les enfants ?", o: ["Dans une cave", "Contre un mur avec un matelas", "Sous un lit"], a: 1 },
                    { t: 'tf', cat: 'detail', q: "Il y avait des tranch√©es au milieu de la rue.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Comment les bombes tombaient-elles ?", o: ["Par ricochet", "Verticalement", "Par parachute"], a: 0 },
                    { t: 'tf', cat: 'global', q: "La narratrice se rend compte aujourd'hui de la gravit√©.", a: true },
                    { t: 'input', cat: 'detail', q: "Que criaient les gens √† la fin ?", a: "bravo" },
                    { t: 'mcq', cat: 'detail', q: "Que voyaient-ils passer avant de se cacher ?", o: ["Des chars", "Des avions", "Des bateaux"], a: 1 }
                ]
            },
            {
                title: "6. L'Arc de Triomphe Empaquet√©",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/arc_de_triomphe_empaquete_manue.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Qui sont les artistes ?", o: ["Christo et Jeanne-Claude", "Dali et Gala", "Rodin et Claudel"], a: 0 },
                    { t: 'num', cat: 'num', q: "Combien de semaines l'installation a-t-elle dur√© ?", a: "3" },
                    { t: 'tf', cat: 'detail', q: "La Place de l'√âtoile est rest√©e ouverte aux voitures.", a: false, expl: "Ferm√©e √† la circulation." },
                    { t: 'mcq', cat: 'detail', q: "Quelle couleur avait le tissu ?", o: ["Argent√© / Recyclable", "Rouge", "Dor√©"], a: 0 },
                    { t: 'tf', cat: 'global', q: "Les artistes √©taient vivants lors de l'inauguration.", a: false },
                    { t: 'match', cat: 'global', q: "Concept de l'≈ìuvre :", p: {"Cacher": "Pour r√©v√©ler", "√âph√©m√®re": "Urgence", "Mat√©riau": "Recyclable"} },
                    { t: 'input', cat: 'detail', q: "Quelle place a √©t√© ferm√©e ?", a: "√©toile" },
                    { t: 'mcq', cat: 'detail', q: "Comment le monument paraissait-il ?", o: ["Plus grand", "Plus petit", "Invisible"], a: 0 }
                ]
            },
            {
                title: "7. Lac de l'Eychauda",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/lac_de_l_eychauda.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quel massif montagneux sont-ils ?", a: "√©crins" },
                    { t: 'num', cat: 'num', q: "√Ä quelle altitude se trouve le lac ?", a: "2514" },
                    { t: 'mcq', cat: 'detail', q: "D'o√π vient l'eau du lac ?", o: ["D'un glacier", "D'une source", "De la pluie"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Quelle est la couleur de l'eau (adjectif donn√©) ?", a: "laiteux" },
                    { t: 'mcq', cat: 'detail', q: "Qu'ont-ils vu flotter sur l'eau ?", o: ["Des icebergs", "Des bateaux", "Des feuilles"], a: 0 },
                    { t: 'num', cat: 'num', q: "Combien d'heures de marche pour monter ?", a: "5" },
                    { t: 'num', cat: 'num', q: "Quelle distance totale ont-ils parcourue ?", a: "15" },
                    { t: 'tf', cat: 'global', q: "Il faut partir tard le matin.", a: false, expl: "Partir t√¥t (7h30)." }
                ]
            },
            {
                title: "8. Le Film Wonka",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/wonka.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "De quel auteur vient l'histoire ?", o: ["Roald Dahl", "J.K. Rowling", "Victor Hugo"], a: 0 },
                    { t: 'input', cat: 'detail', q: "M√©tier de Wonka (autre que chocolatier) ?", a: "magicien" },
                    { t: 'input', cat: 'detail', q: "Qui joue le r√¥le principal ?", a: "chalamet" },
                    { t: 'mcq', cat: 'detail', q: "Quel genre de film est-ce ?", o: ["Com√©die musicale", "Thriller", "Documentaire"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Acteur / R√¥le :", p: {"Hugh Grant": "Oompa Loompa", "Atkinson": "Pr√™tre", "Colman": "M√©chante"} },
                    { t: 'tf', cat: 'global', q: "Le film est tr√®s sombre.", a: false, expl: "C'est color√© et f√©√©rique." },
                    { t: 'mcq', cat: 'detail', q: "Pour quelle r√©compense a-t-il √©t√© nomin√© ?", o: ["Golden Globes", "Oscars", "Cannes"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "La narratrice a vu le film en VF.", a: false, expl: "En version originale." }
                ]
            },
            {
                title: "9. √âpicerie Participative",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fredericparc-naturel-re_gional-de-la-haute-valle_e-de-chevreuse.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Pr√©nom du narrateur ?", a: "fr√©d√©ric" },
                    { t: 'num', cat: 'num', q: "Nombre d'habitants dans le village ?", a: "500" },
                    { t: 'mcq', cat: 'detail', q: "Jour d'ouverture ?", o: ["Samedi", "Dimanche", "Lundi"], a: 0 },
                    { t: 'num', cat: 'num', q: "Ann√©e d'ouverture de l'√©picerie ?", a: "2021" },
                    { t: 'tf', cat: 'detail', q: "Il y a 100 membres.", a: false, expl: "Une vingtaine." },
                    { t: 'mcq', cat: 'global', q: "Quel est l'objectif social ?", o: ["Convivialit√©", "Profit", "√âlections"], a: 0 },
                    { t: 'input', cat: 'detail', q: "D'o√π viennent les produits ?", a: "locaux" },
                    { t: 'tf', cat: 'detail', q: "On peut boire un caf√© sur place.", a: true },
                    { t: 'mcq', cat: 'detail', q: "D√©lai de r√©servation des produits ?", o: ["1 ou 2 semaines", "24 heures", "1 mois"], a: 0 }
                ]
            },
            {
                title: "10. La Picardie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_001.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "O√π se situe la Picardie ?", o: ["Dans le Nord", "Dans le Sud", "√Ä l'Est"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Capitale r√©gionale ?", a: "amiens" },
                    { t: 'match', cat: 'detail', q: "Associez le lieu √† sa particularit√© :", p: {"Chantilly": "For√™t/Ch√¢teau", "Hortillonnages": "Jardins sur l'eau", "Pierrefonds": "Ch√¢teau fort"} },
                    { t: 'input', cat: 'detail', q: "√âcrivain c√©l√®bre d'Amiens ?", a: "verne" },
                    { t: 'mcq', cat: 'detail', q: "Que sont les 'hortillonnages' ?", o: ["Jardins sur l'eau", "Cath√©drales", "Plats"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "On visite les hortillonnages en voiture.", a: false, expl: "En barque." },
                    { t: 'mcq', cat: 'detail', q: "Quelle ville a un cachet ancien (d√©cor de film) ?", o: ["Senlis", "Beauvais", "Lille"], a: 0 },
                    { t: 'tf', cat: 'global', q: "La r√©gion manque de verdure.", a: false }
                ]
            },
            {
                title: "11. Engagement Associatif",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_002.mp3",
                questions: [
                    { t: 'input', cat: 'num', q: "√Çge de la narratrice ?", a: "58" },
                    { t: 'mcq', cat: 'detail', q: "Son m√©tier ?", o: ["Professeur", "M√©decin", "Comptable"], a: 0 },
                    { t: 'num', cat: 'num', q: "Nombre d'associations ?", a: "2" },
                    { t: 'match', cat: 'detail', q: "R√¥le / Asso :", p: {"Profs": "Tr√©sori√®re", "Voitures": "Secr√©taire"} },
                    { t: 'tf', cat: 'detail', q: "L'asso de voitures publie un bulletin 3 fois par an.", a: true },
                    { t: 'mcq', cat: 'global', q: "Pourquoi s'engage-t-elle ?", o: ["Pour √™tre utile", "Pour l'argent", "Pour voyager"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Que r√©colte-t-elle pour les profs ?", a: "cotisations" },
                    { t: 'tf', cat: 'global', q: "Elle pense qu'il faut rester repli√© sur soi.", a: false }
                ]
            },
            {
                title: "12. Le Cirque 100% Humain",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/le_cirque.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "Quelle est la particularit√© de ce cirque ?", o: ["Pas d'animaux", "Gratuit", "Sous l'eau"], a: 0 },
                    { t: 'input', cat: 'num', q: "Dur√©e du spectacle (heures) ?", a: "2" },
                    { t: 'mcq', cat: 'detail', q: "Lieu du chapiteau ?", o: ["Pelouse de Reuilly", "Champs de Mars", "La D√©fense"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Artiste / Action :", p: {"Trap√©zistes": "Vols", "Jongleurs": "Objets", "Funambules": "Moto sur fil"} },
                    { t: 'num', cat: 'num', q: "Capacit√© max du chapiteau ?", a: "3000" },
                    { t: 'tf', cat: 'detail', q: "Il faisait tr√®s chaud.", a: false, expl: "Froid (janvier)." },
                    { t: 'mcq', cat: 'detail', q: "Qu'est-ce que la 'roue infernale' ?", o: ["Deux roues avec des acrobates", "Une moto", "Un cercle de feu"], a: 0 },
                    { t: 'input', cat: 'num', q: "Prix moyen d'une place (euros) ?", a: "20" }
                ]
            },
            {
                title: "13. France Miniature",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/france_miniatures.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "D√©partement ?", a: "yvelines" },
                    { t: 'mcq', cat: 'detail', q: "Ville ?", o: ["√âlancourt", "Versailles", "Rambouillet"], a: 0 },
                    { t: 'num', cat: 'num', q: "Prix billet enfant (4-11 ans) ?", a: "21" },
                    { t: 'num', cat: 'num', q: "Prix billet adulte ?", a: "27" },
                    { t: 'num', cat: 'num', q: "Prix parking ?", a: "5" },
                    { t: 'match', cat: 'detail', q: "R√©gion / Monument :", p: {"Nord": "Cath√©drale d'Amiens", "Ouest": "Mont Saint Michel", "Est": "Village Alsacien"} },
                    { t: 'tf', cat: 'global', q: "On peut visiter toute la France en une fois.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Monument parisien cit√© √† la fin ?", o: ["Tour Eiffel", "Louvre", "Sacr√© C≈ìur"], a: 0 }
                ]
            },
            {
                title: "14. La R√©cr√© des 3 Cur√©s",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/recre_des_3_cures.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "D√©partement breton ?", a: "finist√®re" },
                    { t: 'mcq', cat: 'detail', q: "Ouverture ?", o: ["Avril √† Novembre", "Juin √† Ao√ªt", "Toute l'ann√©e"], a: 0 },
                    { t: 'num', cat: 'num', q: "Prix billet adulte ?", a: "23" },
                    { t: 'tf', cat: 'detail', q: "Le parc est payant pour les b√©b√©s.", a: false, expl: "Gratuit -1m." },
                    { t: 'input', cat: 'detail', q: "Nom du grand huit vertical : Le ___.", a: "vertika" },
                    { t: 'match', cat: 'detail', q: "Attraction / Type :", p: {"Niagara": "Bou√©e", "Galion": "Bateau pirate", "Tuf Tuf": "Tracteurs"} },
                    { t: 'tf', cat: 'detail', q: "Le parking est payant.", a: false },
                    { t: 'mcq', cat: 'detail', q: "Comment faire le tour du parc ?", o: ["Petit train", "H√©licopt√®re", "√Ä cheval"], a: 0 }
                ]
            },
            {
                title: "15. Voyage F1 en Italie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/site-170424-melyne-audio-italie.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Premi√®re ville visit√©e ?", o: ["Milan", "Rome", "Turin"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Ville du Grand Prix ?", a: "monza" },
                    { t: 'input', cat: 'detail', q: "Lac visit√© ?", a: "c√¥me" },
                    { t: 'tf', cat: 'global', q: "C'est un voyage improvis√©.", a: false, expl: "Bien planifi√©." },
                    { t: 'mcq', cat: 'detail', q: "Visite √† Milan ?", o: ["Cath√©drale (Duomo)", "Mus√©e", "Stade"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Elles vont manger dans des fast-foods.", a: false },
                    { t: 'mcq', cat: 'global', q: "Sentiment de la narratrice ?", o: ["Impatience / Excitation", "Peur", "Ennui"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Avec qui part-elle ?", a: "amie" }
                ]
            },
            {
                title: "16. Spectacle au Panth√©on",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/pantheon_manue.mp3",
                questions: [
                    { t: 'input', cat: 'num', q: "Nombre de femmes ?", a: "60" },
                    { t: 'input', cat: 'detail', q: "Ville partenaire :", a: "colombes" },
                    { t: 'mcq', cat: 'global', q: "Forme du spectacle ?", o: ["D√©ambulation", "Assis", "Virtuel"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Toutes √©taient professionnelles.", a: false },
                    { t: 'match', cat: 'detail', q: "√âl√©ment / Artiste :", p: {"Danse": "Chor√©graphe pro", "Audio": "Podcasts", "Chant": "Com√©diennes"} },
                    { t: 'input', cat: 'detail', q: "C√©l√©brit√© honor√©e ?", a: "baker" },
                    { t: 'num', cat: 'num', q: "Dur√©e du projet (ans) ?", a: "1" },
                    { t: 'tf', cat: 'global', q: "Le but : questionner la place de la femme.", a: true }
                ]
            },
            {
                title: "17. Bombardement (8 Mars 1944)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombardement_8_mars_44.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Destination de la narratrice ?", o: ["La poste", "La gare", "L'√©cole"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Contenu du colis :", a: "volaille" },
                    { t: 'mcq', cat: 'detail', q: "Bruit entendu ?", o: ["Sir√®nes", "Musique", "Tonnerre"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Elle est rentr√©e chez elle tout de suite.", a: false, expl: "Cach√©e dans une cave." },
                    { t: 'input', cat: 'detail', q: "Transport laiss√© au pont ?", a: "v√©lo" },
                    { t: 'mcq', cat: 'detail', q: "Qui gardait le pont ?", o: ["Police allemande", "R√©sistants", "Am√©ricains"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Description Allemands :", p: {"T√™te": "Casqu√©s", "Ceinture": "Cha√Æne", "Bottes": "Bott√©s"} },
                    { t: 'tf', cat: 'global', q: "Elle avait peur des chiens.", a: true }
                ]
            },
            {
                title: "18. La Lib√©ration",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fin_de_la_guerre.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Lib√©rateurs :", a: "am√©ricains" },
                    { t: 'input', cat: 'detail', q: "Cadeaux lanc√©s :", a: "bonbons" }, 
                    { t: 'mcq', cat: 'global', q: "Sentiment dominant ?", o: ["Joie", "Peur", "Col√®re"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Les gens restaient cach√©s chez eux.", a: false },
                    { t: 'mcq', cat: 'detail', q: "Soldats :", o: ["Debout dans les jeeps", "Cach√©s", "√Ä pied"], a: 0 },
                    { t: 'input', cat: 'detail', q: "R√©gion de la grand-m√®re ?", a: "finist√®re" },
                    { t: 'input', cat: 'detail', q: "Action des gens : Ils ___.", a: "applaudissaient" },
                    { t: 'tf', cat: 'detail', q: "Il y avait beaucoup d'enfants.", a: false }
                ]
            }
        ];

        // ==========================================
        // ‚öôÔ∏è ENGINE LOGIC
        // ==========================================
        
        // üõë PASTE YOUR GOOGLE SCRIPT URL HERE üõë
        const API_URL = "PASTE_YOUR_GOOGLE_SCRIPT_URL_HERE";

        let currentExam = [];
        let currentTrackIdx = 0;
        let score = 0;
        let maxScore = 0;
        let startTime;
        let catScores = { global: {g:0, m:0}, detail: {g:0, m:0}, num: {g:0, m:0} };

        // --- GLOBAL FUNCTIONS ---
        // These MUST be global for the HTML onclick to find them
        window.startExam = function() {
            try {
                currentExam = [...database].sort(() => 0.5 - Math.random()).slice(0, 3);
                document.getElementById('intro').classList.add('hidden');
                document.getElementById('exam-ui').classList.remove('hidden');
                startTime = new Date();
                loadTrack(0);
                
                setInterval(() => {
                    const diff = Math.floor((new Date() - startTime) / 1000);
                    const m = String(Math.floor(diff/60)).padStart(2,'0');
                    const s = String(diff%60).padStart(2,'0');
                    document.getElementById('timer').innerText = `${m}:${s}`;
                }, 1000);
            } catch (e) {
                alert("Erreur de d√©marrage: " + e);
            }
        }

        function loadTrack(idx) {
            currentTrackIdx = idx;
            const data = currentExam[idx];
            document.getElementById('track-title').innerText = data.title;
            document.getElementById('audio-src').src = data.url;
            document.getElementById('player').load();
            document.getElementById('track-idx').innerText = idx + 1;

            const container = document.getElementById('q-container');
            container.innerHTML = '';

            data.questions.forEach((q, i) => {
                const box = document.createElement('div');
                box.className = 'q-block';
                box.id = `q-${i}`;
                box.dataset.type = q.t;
                box.dataset.cat = q.cat;
                
                let typeName = q.t === 'mcq' ? "Choix Multiple" : q.t === 'num' ? "Chiffres" : q.t === 'match' ? "Correspondance" : q.t === 'tf' ? "Vrai / Faux" : "Compl√©ter";
                let html = `<div class="q-header">
                                <div class="q-num">${i+1}</div>
                                <div>
                                    <div class="q-tag">${typeName} ‚Ä¢ ${q.cat}</div>
                                    <div class="q-text">${q.q}</div>
                                </div>
                            </div>`;

                if(q.t === 'mcq') {
                    html += `<div class="mcq-grid">`;
                    const opts = q.o.map((val, idx) => ({val, idx})).sort(() => 0.5 - Math.random());
                    opts.forEach(opt => {
                        html += `<div class="mcq-opt" onclick="selectMCQ(this, '${i}', '${opt.idx}')">${opt.val}</div>`;
                    });
                    html += `<input type="hidden" id="ans-${i}"></div>`;
                }
                else if(q.t === 'tf') {
                    html += `<div class="tf-container">
                        <div class="tf-btn" onclick="selectTF(this, '${i}', 'true')">VRAI</div>
                        <div class="tf-btn" onclick="selectTF(this, '${i}', 'false')">FAUX</div>
                        <input type="hidden" id="ans-${i}">
                    </div>`;
                }
                else if(q.t === 'match') {
                    html += `<div class="match-grid">`;
                    const keys = Object.keys(q.p);
                    const vals = Object.values(q.p).sort(() => 0.5 - Math.random());
                    keys.forEach((k, kIdx) => {
                        let opts = `<option value="">---</option>`;
                        vals.forEach(v => opts += `<option value="${v}">${v}</option>`);
                        html += `<div class="match-row">
                                    <div style="font-weight:bold;">${k}</div>
                                    <select id="match-${i}-${kIdx}">${opts}</select>
                                 </div>`;
                    });
                    html += `</div>`;
                }
                else { 
                    html += `<input type="text" id="ans-${i}" placeholder="Tapez votre r√©ponse...">`;
                }

                html += `<div class="feedback" id="feed-${i}"></div>`;
                box.innerHTML = html;
                container.appendChild(box);
            });
        }

        // Renamed functions attached to window
        window.selectMCQ = function(el, qId, val) {
            el.parentNode.querySelectorAll('.mcq-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(`ans-${qId}`).value = val;
        }

        window.selectTF = function(el, qId, val) {
            el.parentNode.querySelectorAll('.tf-btn').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(`ans-${qId}`).value = val;
        }

        window.checkAnswers = function() {
            try {
                const data = currentExam[currentTrackIdx];
                document.getElementById('next-btn').disabled = true;

                data.questions.forEach((q, i) => {
                    const feed = document.getElementById(`feed-${i}`);
                    if(!feed) return; // safety check

                    let isRight = false;
                    catScores[q.cat].m++;
                    maxScore++;

                    if (q.t === 'mcq') {
                        let val = document.getElementById(`ans-${i}`).value;
                        if (val && parseInt(val) === q.a) isRight = true;
                    }
                    else if (q.t === 'tf') {
                        let val = document.getElementById(`ans-${i}`).value;
                        if (val === String(q.a)) isRight = true;
                    }
                    else if (q.t === 'match') {
                        let all = true;
                        Object.keys(q.p).forEach((k, kIdx) => {
                            let matchVal = document.getElementById(`match-${i}-${kIdx}`).value;
                            if(matchVal !== q.p[k]) all = false;
                        });
                        if (all) isRight = true;
                    }
                    else {
                        const inputEl = document.getElementById(`ans-${i}`);
                        const val = inputEl.value.trim().toLowerCase().replace(',','.');
                        const ans = String(q.a).toLowerCase().replace(',','.');
                        
                        if (val === ans || (val.length > 2 && ans.includes(val))) isRight = true;
                        // Special logic for bonus words
                        if ((ans === "chewing-gums" && val.includes("bonbon")) || (ans==="bonbons" && val.includes("chewing"))) isRight = true;
                    }

                    feed.style.display = 'block';
                    if (isRight) {
                        score++;
                        catScores[q.cat].g++;
                        feed.innerHTML = "‚úÖ Correct !";
                        feed.className = "feedback good";
                    } else {
                        let txt = q.a;
                        if (q.t === 'mcq') txt = q.o[q.a];
                        if (q.t === 'tf') txt = q.a ? "Vrai" : "Faux";
                        if (q.t === 'match') txt = "Voir correspondances";
                        
                        feed.innerHTML = `‚ùå Faux. R√©ponse : <strong>${txt}</strong>`;
                        if(q.expl) feed.innerHTML += `<br>‚ÑπÔ∏è ${q.expl}`;
                        feed.className = "feedback bad";
                    }
                });

                setTimeout(() => {
                    document.getElementById('next-btn').disabled = false;
                    if (currentTrackIdx < 2) {
                        loadTrack(currentTrackIdx + 1);
                    } else {
                        finishExam();
                    }
                }, 3000);
            } catch (err) {
                alert("Erreur validation: " + err);
                console.error(err);
                document.getElementById('next-btn').disabled = false;
            }
        }

        window.finishExam = function() {
            document.getElementById('exam-ui').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            const totalTime = Math.floor((new Date() - startTime)/1000);
            const m = Math.floor(totalTime/60);
            const s = totalTime%60;
            const avg = Math.round(totalTime/3);
            const perc = Math.round((score/maxScore)*100);

            let weak = "Aucun";
            let minP = 101;
            const labels = {'global':'Compr√©hension Globale', 'detail':'D√©tails', 'num':'Chiffres'};
            
            for(let k in catScores) {
                if(catScores[k].m > 0) {
                    let p = (catScores[k].g / catScores[k].m) * 100;
                    if(p < minP) { minP = p; weak = labels[k]; }
                }
            }

            document.getElementById('final-score').innerText = `${score}/${maxScore}`;
            document.getElementById('res-time').innerText = `${m}m ${s}s`;
            document.getElementById('res-acc').innerText = `${perc}%`;
            document.getElementById('res-weak').innerText = weak + ` (${Math.round(minP)}%)`;
            document.getElementById('res-avg').innerText = `${avg}s`;

            if(!API_URL.includes("PASTE")) {
                const payload = {
                    app_secret: "IB_FRENCH_2025_SECURE",
                    sheetName: "Listening_Analytics",
                    date: new Date().toLocaleDateString('en-SG'),
                    startTime: startTime.toLocaleTimeString('en-SG'),
                    duration: `${m}m ${s}s`,
                    score: score,
                    total: maxScore,
                    percentage: `${perc}%`,
                    avgTimePerTrack: avg,
                    weakness: weak,
                    catScores: {
                        global: `${catScores.global.g}/${catScores.global.m}`,
                        detail: `${catScores.detail.g}/${catScores.detail.m}`,
                        num: `${catScores.num.g}/${catScores.num.m}`
                    }
                };

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(() => {
                    document.getElementById('api-status').innerText = "‚úÖ R√©sultats sauvegard√©s !";
                    document.getElementById('api-status').style.color = "green";
                });
            }
        }
    </script>
</body>
</html>
