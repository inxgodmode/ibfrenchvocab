<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá´üá∑ IB Listening: Exam Mode (Fixed)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --text: #1e293b;
            --correct: #16a34a;
            --wrong: #dc2626;
            --border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; background: var(--card); border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid var(--border); }
        
        /* Header */
        .top-bar { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.9em; }

        /* Audio Player */
        .audio-box { background: #eff6ff; padding: 25px; text-align: center; border-bottom: 1px solid var(--border); }
        audio { width: 100%; max-width: 600px; margin-top: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 30px; }
        .track-title { font-size: 1.4em; font-weight: 800; color: var(--primary-dark); }

        /* Content Area */
        .content { padding: 40px; }
        .question-block { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed var(--border); }
        .question-block:last-child { border-bottom: none; }
        
        .q-header { display: flex; align-items: baseline; margin-bottom: 15px; }
        .q-num { background: var(--text); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .q-text { font-weight: 700; font-size: 1.1em; }

        /* Inputs */
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; box-sizing: border-box; transition: 0.2s; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; }

        /* MCQ Grid */
        .mcq-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .mcq-opt { padding: 12px 15px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .mcq-opt:hover { background: #f1f5f9; border-color: var(--primary); }
        .mcq-opt.selected { background: #dbeafe; border-color: var(--primary); color: var(--primary-dark); }
        .mcq-opt.correct { background: #dcfce7 !important; border-color: var(--correct) !important; color: #14532d; }
        .mcq-opt.wrong { background: #fee2e2 !important; border-color: var(--wrong) !important; color: #7f1d1d; opacity: 0.6; }

        /* Matching */
        .match-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; align-items: center; }
        .match-label { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        select { padding: 10px; border-radius: 6px; border: 2px solid var(--border); width: 100%; }

        /* TRUE/FALSE grid */
        .tf-grid { display: flex; gap: 15px; }
        .tf-btn { flex: 1; text-align: center; font-weight: bold; }

        /* Footer */
        .footer { padding: 20px 40px; background: #f8fafc; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }
        .btn { background: var(--primary); color: white; padding: 14px 30px; border-radius: 10px; border: none; font-weight: 700; font-size: 1em; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }

        .feedback { margin-top: 10px; font-weight: 600; padding: 10px; border-radius: 6px; display: none; }
        .feedback.good { background: #dcfce7; color: #166534; }
        .feedback.bad { background: #fee2e2; color: #991b1b; }

        .hidden { display: none !important; }
        
        /* Summary */
        .stat-box { background: white; border: 1px solid var(--border); padding: 20px; border-radius: 10px; margin: 10px 0; text-align: left; }
    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="intro" class="container" style="text-align:center; padding: 60px 40px;">
        <h1 style="color:var(--primary); font-size: 2.5em; margin-bottom: 10px;">üá´üá∑ Examen d'√âcoute IB</h1>
        <p style="font-size: 1.2em; color: #64748b;">G√©n√©rateur de Test Al√©atoire (Version Corrig√©e)</p>
        <div style="background: #eff6ff; padding: 20px; border-radius: 10px; margin: 30px 0; display: inline-block; text-align: left;">
            <p>‚úÖ <strong>3 Pistes Audio</strong> (S√©lectionn√©es au hasard parmi 18)</p>
            <p>‚úÖ <strong>Questions IB Officielles</strong> (QCM, Tableaux, Vrai/Faux)</p>
            <p>‚úÖ <strong>Anti-Triche</strong> (R√©ponses m√©lang√©es)</p>
        </div>
        <br>
        <button class="btn" onclick="startExam()">LANCER L'EXAMEN</button>
    </div>

    <!-- EXAM UI -->
    <div id="exam-ui" class="container hidden">
        <div class="top-bar">
            <span id="progress-text">Piste 1 / 3</span>
            <span class="badge" id="timer">00:00</span>
        </div>

        <div class="audio-box">
            <div class="track-title" id="track-title">Titre de la piste</div>
            <audio id="player" controls controlsList="nodownload"><source id="audio-src" src="" type="audio/mpeg"></audio>
        </div>

        <div class="content" id="q-container">
            <!-- Questions go here -->
        </div>

        <div class="footer">
            <button class="btn" id="next-btn" onclick="checkAndNext()">Valider & Suivant</button>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="container hidden" style="text-align:center; padding: 50px;">
        <h1 style="color:var(--primary);">R√©sultats du Test</h1>
        <div style="font-size: 4em; font-weight: 800; color: var(--text);" id="final-score">0/0</div>
        
        <div class="stat-box">
            <p><strong>‚è±Ô∏è Dur√©e :</strong> <span id="res-time"></span></p>
            <p><strong>üìâ Point Faible :</strong> <span id="res-weak" style="color:var(--wrong);"></span></p>
            <p><strong>üìä Pr√©cision :</strong> <span id="res-acc"></span></p>
        </div>

        <p id="api-status" style="margin-top:20px; color:#64748b;">Sauvegarde...</p>
        <button class="btn" style="margin-top:20px; background: #64748b;" onclick="location.reload()">Nouveau Test</button>
    </div>

    <script>
        // =========================================================
        // üìö DATABASE (Cleaned & Safe)
        // =========================================================
        const fullDatabase = [
            {
                title: "1. S√©rie 'Berlin' (Netflix)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/berlin.mp3",
                questions: [
                    { t: 'mcq', tag: 'global', q: "De quelle s√©rie 'Berlin' est-elle le spin-off ?", o: ["Lupin", "La Casa de Papel", "Elite"], a: 1 },
                    { t: 'tf', tag: 'detail', q: "L'histoire se d√©roule apr√®s la mort de Berlin.", a: false, expl: "C'est un pr√©quel (avant)." },
                    { t: 'input', tag: 'detail', q: "Dans quelle capitale europ√©enne l'action se situe-t-elle ?", a: "Paris" },
                    { t: 'num', tag: 'num', q: "Combien de millions d'euros le butin vaut-il ?", a: "44" },
                    { t: 'match', tag: 'detail', q: "Associez les chiffres :", p: {"Nombre d'√©pisodes": "8", "Villes d'origine des bijoux": "34", "Soir√©es pour voler": "1"} },
                    { t: 'tf', tag: 'global', q: "La s√©rie est plus violente que l'originale.", a: false, expl: "Moins violente, plus romantique." },
                    { t: 'mcq', tag: 'detail', q: "Quel est le style principal ?", o: ["Horreur", "Romantique", "Documentaire"], a: 1 },
                    { t: 'input', tag: 'num', q: "Mois de sortie (2024) ?", a: "janvier" }
                ]
            },
            {
                title: "2. H√¥tel de la Marine",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/constantin_l_hotel_de_la_marine_a_paris.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "Sur quelle place se situe le monument ?", o: ["Bastille", "Concorde", "Vend√¥me"], a: 1 },
                    { t: 'input', tag: 'num', q: "En quelle ann√©e a-t-il ouvert au public ?", a: "2021" },
                    { t: 'input', tag: 'num', q: "De quel si√®cle date la construction ?", a: "18" },
                    { t: 'tf', tag: 'detail', q: "Le narrateur a ador√© l'audioguide.", a: false, expl: "Il l'a trouv√© g√™nant." },
                    { t: 'mcq', tag: 'global', q: "Avant la R√©volution, qu'√©tait ce b√¢timent ?", o: ["Le Garde-Meuble du Roi", "Une prison", "Un h√¥pital"], a: 0 },
                    { t: 'match', tag: 'detail', q: "Associez :", p: {"Salle de Bal": "Galerie des Glaces", "Appartements": "Intendant", "Loggia": "Vue"} },
                    { t: 'mcq', tag: 'detail', q: "Pourquoi a-t-on nettoy√© les fa√ßades ?", o: ["Pollution", "Graffitis", "Incendie"], a: 0 },
                    { t: 'input', tag: 'detail', q: "H√¥tel voisin ?", a: "crillon" }
                ]
            },
            {
                title: "3. Le Puy du Fou",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/puy_du_fou.mp3",
                questions: [
                    { t: 'input', tag: 'detail', q: "Dans quel d√©partement se trouve le parc ?", a: "Vend√©e" },
                    { t: 'num', tag: 'num', q: "Quel est le prix du billet adulte (en ‚Ç¨) ?", a: "44" },
                    { t: 'mcq', tag: 'detail', q: "Quel spectacle met en sc√®ne des oiseaux ?", o: ["Les Vikings", "Le Bal des Oiseaux Fant√¥mes", "Le Secret de la Lance"], a: 1 },
                    { t: 'match', tag: 'detail', q: "Associez le th√®me au spectacle :", p: {"Tranch√©es": "Amoureux de Verdun", "Gladiateurs": "Signe du Triomphe", "Drakkars": "Vikings"} },
                    { t: 'tf', tag: 'global', q: "Le narrateur recommande ce parc.", a: true },
                    { t: 'num', tag: 'num', q: "Combien de fois √©lu meilleur parc du monde ?", a: "2" },
                    { t: 'mcq', tag: 'detail', q: "Que font les Vikings ?", o: ["Ils surgissent de l'eau", "Ils volent", "Ils chantent"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Type de course dans l'ar√®ne : Course de ___.", a: "chars" }
                ]
            },
            {
                title: "4. Match de Football",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/stephane_un_beau_match_de_foot.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "Quelles √©quipes s'affrontaient ?", o: ["PSG/OM", "City/Real Madrid", "Liverpool/Chelsea"], a: 1 },
                    { t: 'num', tag: 'num', q: "Quelle √©tait la date du match (jour et mois) ?", a: "26 avril" },
                    { t: 'input', tag: 'detail', q: "Quel joueur fran√ßais a marqu√© deux buts ?", a: "Benzema" },
                    { t: 'mcq', tag: 'global', q: "Pourquoi le narrateur aime les clubs anglais ?", o: ["Ils jouent vite", "Ils trichent", "Ils sont lents"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Il y a eu beaucoup de fautes pendant le match.", a: false },
                    { t: 'mcq', tag: 'detail', q: "Niveau de la comp√©tition ?", o: ["Finale", "Demi-finale", "Amical"], a: 1 },
                    { t: 'input', tag: 'num', q: "Nombre de buts de Benzema ?", a: "2" },
                    { t: 'mcq', tag: 'global', q: "Le match √©tait :", o: ["Spectaculaire", "Ennuyeux", "Moyen"], a: 0 }
                ]
            },
            {
                title: "5. Souvenirs de Guerre (Caen)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombes_caen.mp3",
                questions: [
                    { t: 'input', tag: 'detail', q: "Dans quelle ville normande se passe l'histoire ?", a: "Caen" },
                    { t: 'num', tag: 'num', q: "Quelle diff√©rence d'√¢ge avec sa s≈ìur ?", a: "6" },
                    { t: 'mcq', tag: 'detail', q: "O√π la m√®re cachait-elle les enfants ?", o: ["Dans une cave", "Derri√®re un matelas contre un mur", "Dans un abri anti-a√©rien"], a: 1 },
                    { t: 'input', tag: 'detail', q: "Que donnaient les soldats am√©ricains aux enfants ?", a: "chewing-gums" },
                    { t: 'tf', tag: 'global', q: "La narratrice comprenait la gravit√© √† l'√©poque.", a: false },
                    { t: 'mcq', tag: 'detail', q: "Pourquoi pas les tranch√©es ?", o: ["Trop loin/Pas le temps", "Inond√©es", "Ferm√©es"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Il y avait beaucoup de maisons autour.", a: false, expl: "Quelques maisons seulement." },
                    { t: 'input', tag: 'detail', q: "Les gens criaient ___.", a: "bravo" }
                ]
            },
            {
                title: "6. L'Arc de Triomphe Empaquet√©",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/arc_de_triomphe_empaquete_manue.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "Qui sont les artistes ?", o: ["Christo et Jeanne-Claude", "Dali et Gala", "Rodin et Claudel"], a: 0 },
                    { t: 'num', tag: 'num', q: "Combien de semaines l'installation a-t-elle dur√© ?", a: "3" },
                    { t: 'tf', tag: 'detail', q: "Le tissu utilis√© √©tait recyclable.", a: true },
                    { t: 'mcq', tag: 'global', q: "Quel √©tait l'objectif artistique ?", o: ["Cacher pour mieux r√©v√©ler", "Prot√©ger le monument", "Faire de la publicit√©"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Quelle place a √©t√© ferm√©e √† la circulation ?", a: "√©toile" },
                    { t: 'tf', tag: 'global', q: "Les artistes √©taient pr√©sents √† l'inauguration.", a: false, expl: "Ils sont d√©c√©d√©s." },
                    { t: 'mcq', tag: 'detail', q: "Le monument paraissait :", o: ["Plus grand", "Plus petit", "Sale"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Ville partenaire :", a: "colombes" }
                ]
            },
            {
                title: "7. Randonn√©e Lac de l'Eychauda",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/lac_de_l_eychauda.mp3",
                questions: [
                    { t: 'num', tag: 'num', q: "√Ä quelle altitude se trouve le lac ?", a: "2514" },
                    { t: 'input', tag: 'detail', q: "Quelle est la couleur de l'eau (adjectif donn√©) ?", a: "laiteux" },
                    { t: 'mcq', tag: 'detail', q: "D'o√π vient l'eau ?", o: ["Pluie", "Glacier", "Rivi√®re"], a: 1 },
                    { t: 'num', tag: 'num', q: "Combien d'heures de marche pour monter ?", a: "5" },
                    { t: 'tf', tag: 'detail', q: "Il est conseill√© de partir en d√©but d'apr√®s-midi.", a: false, expl: "Il faut partir t√¥t le matin." },
                    { t: 'mcq', tag: 'detail', q: "Qu'ont-ils vu flotter sur l'eau ?", o: ["Des icebergs", "Des bateaux", "Des feuilles"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Massif montagneux ?", a: "√©crins" },
                    { t: 'num', tag: 'num', q: "Distance totale (km) ?", a: "15" }
                ]
            },
            {
                title: "8. Le Film Wonka",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/wonka.mp3",
                questions: [
                    { t: 'mcq', tag: 'global', q: "De quel livre s'inspire le film ?", o: ["Charlie et la Chocolaterie", "Matilda", "Le Bon Gros G√©ant"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Qui joue Willy Wonka ?", a: "chalamet" },
                    { t: 'match', tag: 'detail', q: "Associez l'acteur au r√¥le :", p: {"Hugh Grant": "Oompa Loompa", "Rowan Atkinson": "Pr√™tre", "Olivia Colman": "M√©chante"} },
                    { t: 'mcq', tag: 'detail', q: "Quel genre de film est-ce ?", o: ["Documentaire", "Com√©die musicale", "Thriller"], a: 1 },
                    { t: 'tf', tag: 'detail', q: "Le film est sorti en √©t√©.", a: false, expl: "En d√©cembre." },
                    { t: 'input', tag: 'detail', q: "Autre m√©tier de Wonka (magicien et...) ?", a: "inventeur" },
                    { t: 'mcq', tag: 'detail', q: "Nomination pour quelle r√©compense ?", o: ["Golden Globes", "Cannes", "C√©sar"], a: 0 },
                    { t: 'tf', tag: 'global', q: "C'est un film triste.", a: false }
                ]
            },
            {
                title: "9. √âpicerie Participative",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fredericparc-naturel-re_gional-de-la-haute-valle_e-de-chevreuse.mp3",
                questions: [
                    { t: 'input', tag: 'num', q: "Combien d'habitants compte le village ?", a: "500" },
                    { t: 'mcq', tag: 'detail', q: "Quel jour l'√©picerie ouvre-t-elle ?", o: ["Samedi", "Dimanche", "Lundi"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Les produits viennent de l'√©tranger.", a: false, expl: "Des producteurs locaux." },
                    { t: 'input', tag: 'num', q: "En quelle ann√©e l'√©picerie a-t-elle ouvert ?", a: "2021" },
                    { t: 'mcq', tag: 'global', q: "Quel est le but principal en plus de vendre ?", o: ["Faire du profit", "Cr√©er du lien social", "Vider les stocks"], a: 1 },
                    { t: 'input', tag: 'detail', q: "Pr√©nom du narrateur ?", a: "fr√©d√©ric" },
                    { t: 'tf', tag: 'detail', q: "On peut boire un caf√© sur place.", a: true },
                    { t: 'mcq', tag: 'detail', q: "D√©lai de r√©servation ?", o: ["1-2 semaines", "24h", "1 mois"], a: 0 }
                ]
            },
            {
                title: "10. La Picardie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_001.mp3",
                questions: [
                    { t: 'input', tag: 'detail', q: "Quelle est la capitale de la Picardie ?", a: "amiens" },
                    { t: 'match', tag: 'detail', q: "Associez le lieu √† sa particularit√© :", p: {"Chantilly": "For√™t/Ch√¢teau", "Hortillonnages": "Jardins sur l'eau", "Pierrefonds": "Ch√¢teau fort"} },
                    { t: 'mcq', tag: 'detail', q: "Quel auteur a sa maison √† Amiens ?", o: ["Jules Verne", "Victor Hugo", "Proust"], a: 0 },
                    { t: 'tf', tag: 'global', q: "La r√©gion est d√©crite comme tr√®s industrielle et grise.", a: false, expl: "Elle est verte avec de belles for√™ts." },
                    { t: 'mcq', tag: 'detail', q: "O√π se situe la r√©gion ?", o: ["Nord de la France", "Sud", "Est"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Ville d√©cor de cin√©ma ?", a: "senlis" },
                    { t: 'mcq', tag: 'detail', q: "Comment visiter les hortillonnages ?", o: ["En barque", "√Ä pied", "En train"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Il y a un palais √† Compi√®gne.", a: true }
                ]
            },
            {
                title: "11. Engagement Associatif",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_002.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "Quel est le m√©tier de la narratrice ?", o: ["Professeur", "M√©decin", "Avocate"], a: 0 },
                    { t: 'match', tag: 'detail', q: "Associez le r√¥le √† l'association :", p: {"Tr√©sori√®re": "Assoc. Professeurs", "Secr√©taire": "Voitures anciennes"} },
                    { t: 'input', tag: 'num', q: "Quel √¢ge a-t-elle ?", a: "58" },
                    { t: 'mcq', tag: 'global', q: "Pourquoi s'engage-t-elle ?", o: ["Pour l'argent", "Pour √™tre utile et sortir du quotidien", "Pour la gloire"], a: 0 },
                    { t: 'num', tag: 'num', q: "Nombre d'associations ?", a: "2" },
                    { t: 'input', tag: 'detail', q: "Que collecte-t-elle pour les profs ?", a: "cotisations" },
                    { t: 'tf', tag: 'detail', q: "L'asso de voitures publie un bulletin 3 fois par an.", a: true },
                    { t: 'tf', tag: 'global', q: "Elle pense qu'il faut rester repli√© sur soi.", a: false }
                ]
            },
            {
                title: "12. Le Cirque 100% Humain",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/le_cirque.mp3",
                questions: [
                    { t: 'mcq', tag: 'global', q: "Quelle est la diff√©rence majeure de ce cirque ?", o: ["Pas d'animaux", "Gratuit", "Sans clowns"], a: 0 },
                    { t: 'input', tag: 'num', q: "Combien d'heures dure le spectacle ?", a: "2" },
                    { t: 'mcq', tag: 'detail', q: "O√π est situ√© le cirque ?", o: ["Pelouse de Reuilly", "Bois de Vincennes", "Tour Eiffel"], a: 0 },
                    { t: 'match', tag: 'detail', q: "Associez :", p: {"Trap√©zistes": "Vols en hauteur", "Jongleurs": "Objets", "Funambules": "Moto sur fil"} },
                    { t: 'num', tag: 'num', q: "Combien de spectateurs le chapiteau peut-il accueillir (max) ?", a: "3000" },
                    { t: 'tf', tag: 'detail', q: "Il faisait tr√®s chaud.", a: false, expl: "Froid." },
                    { t: 'input', tag: 'num', q: "Prix d'une place (euros) ?", a: "20" },
                    { t: 'mcq', tag: 'detail', q: "La roue infernale comporte combien de roues ?", o: ["2", "1", "3"], a: 0 }
                ]
            },
            {
                title: "13. France Miniature",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/france_miniatures.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "O√π se situe le parc ?", o: ["√âlancourt", "Versailles", "Paris"], a: 0 },
                    { t: 'input', tag: 'num', q: "Prix du billet pour un enfant de 10 ans ?", a: "21" },
                    { t: 'input', tag: 'num', q: "Prix du parking ?", a: "5" },
                    { t: 'match', tag: 'detail', q: "Associez la r√©gion au monument :", p: {"Nord": "Cath√©drale d'Amiens", "Sud-Ouest": "Pont du Gard", "Paris": "Tour Eiffel"} },
                    { t: 'input', tag: 'num', q: "Prix billet adulte ?", a: "27" },
                    { t: 'tf', tag: 'global', q: "Le parc permet de voir toute la France.", a: true },
                    { t: 'input', tag: 'detail', q: "D√©partement ?", a: "yvelines" },
                    { t: 'mcq', tag: 'detail', q: "Monument de l'Est ?", o: ["Village Alsacien", "Mont St Michel", "Ar√®nes"], a: 0 }
                ]
            },
            {
                title: "14. La R√©cr√© des 3 Cur√©s",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/recre_des_3_cures.mp3",
                questions: [
                    { t: 'input', tag: 'detail', q: "Dans quel d√©partement breton est le parc ?", a: "finist√®re" },
                    { t: 'num', tag: 'num', q: "Prix du billet adulte ?", a: "23" },
                    { t: 'mcq', tag: 'detail', q: "Quelle est l'attraction phare ?", o: ["Le Vertika", "Le Grand Splash", "Le Pirate"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Le parking est payant.", a: false },
                    { t: 'match', tag: 'detail', q: "Attraction/Type :", p: {"Niagara": "Bou√©e", "Galion": "Bateau pirate", "Tuf Tuf": "Tracteurs"} },
                    { t: 'mcq', tag: 'detail', q: "Mois fermeture ?", o: ["Novembre", "Septembre", "D√©cembre"], a: 0 },
                    { t: 'input', tag: 'num', q: "Prix enfant ?", a: "19.50" }, // Fuzzy logic will handle 19,50
                    { t: 'mcq', tag: 'detail', q: "Moyen de transport dans le parc ?", o: ["Petit train", "V√©lo", "Bus"], a: 0 }
                ]
            },
            {
                title: "15. Voyage F1 en Italie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/site-170424-melyne-audio-italie.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "Quelle est la premi√®re ville visit√©e ?", o: ["Milan", "Rome", "Turin"], a: 0 },
                    { t: 'input', tag: 'detail', q: "O√π a lieu le Grand Prix ?", a: "monza" },
                    { t: 'input', tag: 'detail', q: "Quel lac visitent-ils pour se d√©tendre ?", a: "c√¥me" },
                    { t: 'tf', tag: 'global', q: "C'est un voyage improvis√© √† la derni√®re minute.", a: false, expl: "Minutieusement planifi√©." },
                    { t: 'mcq', tag: 'detail', q: "Visite √† Milan ?", o: ["Cath√©drale (Duomo)", "Mus√©e", "Stade"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Elles vont manger dans des fast-foods.", a: false },
                    { t: 'input', tag: 'detail', q: "Compagnon de voyage ?", a: "amie" },
                    { t: 'mcq', tag: 'global', q: "Sentiment de la narratrice ?", o: ["Impatience / Excitation", "Peur", "Tristesse"], a: 0 }
                ]
            },
            {
                title: "16. Spectacle au Panth√©on",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/pantheon_manue.mp3",
                questions: [
                    { t: 'input', tag: 'num', q: "Combien de femmes ont particip√© ?", a: "60" },
                    { t: 'mcq', tag: 'detail', q: "De quelle ville venaient-elles ?", o: ["Colombes", "Courbevoie", "Nanterre"], a: 0 },
                    { t: 'mcq', tag: 'global', q: "Quel √©tait le but du projet ?", o: ["Questionner la place de la femme", "Visiter le monument", "Chanter"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Quelle c√©l√©brit√© entrait au Panth√©on ?", a: "baker" },
                    { t: 'match', tag: 'detail', q: "√âl√©ment / Pro :", p: {"Danse": "Chor√©graphe", "Jeu": "Com√©diennes", "Son": "Podcasts"} },
                    { t: 'num', tag: 'num', q: "Dur√©e du projet (ans) ?", a: "1" },
                    { t: 'tf', tag: 'detail', q: "Toutes √©taient professionnelles.", a: false },
                    { t: 'mcq', tag: 'global', q: "Forme du spectacle ?", o: ["D√©ambulation", "Concert assis", "Film"], a: 0 }
                ]
            },
            {
                title: "17. Bombardement (8 Mars 1944)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombardement_8_mars_44.mp3",
                questions: [
                    { t: 'mcq', tag: 'detail', q: "O√π la narratrice est-elle all√©e ?", o: ["√Ä la poste", "√Ä la boulangerie", "√Ä l'√©cole"], a: 0 },
                    { t: 'input', tag: 'detail', q: "Que contenait le colis pour Paris ?", a: "volaille" }, 
                    { t: 'mcq', tag: 'detail', q: "Qu'a-t-elle entendu en sortant ?", o: ["Les sir√®nes", "Des tirs", "Des cris"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Elle est rentr√©e chez elle imm√©diatement.", a: false, expl: "Elle a d√ª attendre la fin de l'alerte." },
                    { t: 'input', tag: 'detail', q: "Transport laiss√© au pont ?", a: "v√©lo" },
                    { t: 'mcq', tag: 'detail', q: "Qui gardait le pont ?", o: ["Police allemande", "Am√©ricains", "Personne"], a: 0 },
                    { t: 'match', tag: 'detail', q: "Allemands :", p: {"T√™te": "Casqu√©s", "Ceinture": "Cha√Æne", "Bottes": "Bott√©s"} },
                    { t: 'tf', tag: 'global', q: "Elle a eu peur des chiens.", a: true }
                ]
            },
            {
                title: "18. La Lib√©ration",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fin_de_la_guerre.mp3",
                questions: [
                    { t: 'input', tag: 'detail', q: "Qui a lib√©r√© le village ?", a: "am√©ricains" },
                    { t: 'input', tag: 'detail', q: "Que jetaient-ils ?", a: "bonbons" }, 
                    { t: 'mcq', tag: 'global', q: "Quel sentiment dominait ?", o: ["Joie/Soulagement", "Peur", "Tristesse"], a: 0 },
                    { t: 'tf', tag: 'detail', q: "Les gens restaient cach√©s chez eux.", a: false, expl: "Ils sortaient applaudir." },
                    { t: 'mcq', tag: 'detail', q: "Soldats :", o: ["Debout dans les jeeps", "Cach√©s", "√Ä pied"], a: 0 },
                    { t: 'input', tag: 'detail', q: "R√©gion de la grand-m√®re ?", a: "finist√®re" },
                    { t: 'input', tag: 'detail', q: "Action des gens : Ils ___.", a: "applaudissaient" },
                    { t: 'tf', tag: 'detail', q: "Il y avait beaucoup d'enfants.", a: false }
                ]
            }
        ];

        // ==========================================
        // ‚öôÔ∏è ENGINE LOGIC
        // ==========================================
        
        // üõë PASTE SCRIPT URL HERE üõë
        const API_URL = "PASTE_YOUR_GOOGLE_SCRIPT_URL_HERE";

        let currentExam = [];
        let currentTrackIdx = 0;
        let score = 0;
        let maxScore = 0;
        let catScores = { global: {g:0, m:0}, detail: {g:0, m:0}, num: {g:0, m:0} };
        let startTime;

        function startExam() {
            try {
                // Randomize 3 tracks
                currentExam = [...database].sort(() => 0.5 - Math.random()).slice(0, 3);
                
                document.getElementById('intro').classList.add('hidden');
                document.getElementById('exam-ui').classList.remove('hidden');
                
                startTime = new Date();
                loadTrack(0);
                
                setInterval(() => {
                    const diff = Math.floor((new Date() - startTime) / 1000);
                    const m = String(Math.floor(diff/60)).padStart(2,'0');
                    const s = String(diff%60).padStart(2,'0');
                    document.getElementById('timer').innerText = `${m}:${s}`;
                }, 1000);
            } catch (e) {
                alert("Erreur au d√©marrage : " + e);
            }
        }

        function loadTrack(idx) {
            currentTrackIdx = idx;
            const data = currentExam[idx];
            
            document.getElementById('track-title').innerText = data.title;
            document.getElementById('audio-src').src = data.url;
            document.getElementById('player').load();
            document.getElementById('track-idx').innerText = idx + 1;

            const container = document.getElementById('q-container');
            container.innerHTML = '';

            data.questions.forEach((q, i) => {
                const box = document.createElement('div');
                box.className = 'question-block';
                box.id = `q-${i}`;
                box.dataset.type = q.t;
                box.dataset.cat = q.cat;
                
                let typeName = q.t === 'mcq' ? "Choix Multiple" : q.t === 'num' ? "Chiffres" : q.t === 'match' ? "Correspondance" : q.t === 'tf' ? "Vrai / Faux" : "Compl√©ter";
                let html = `<div class="q-header"><span class="q-num">${i+1}</span><div style="flex-grow:1"><small style="color:var(--primary); font-weight:bold; text-transform:uppercase;">${typeName}</small><div class="q-text">${q.q}</div></div></div>`;

                if(q.t === 'mcq') {
                    html += `<div class="mcq-grid">`;
                    const opts = q.o.map((val, idx) => ({val, idx})).sort(() => 0.5 - Math.random());
                    opts.forEach(opt => {
                        html += `<div class="mcq-opt" onclick="selOpt(this, ${i}, ${opt.idx})">${opt.val}</div>`;
                    });
                    html += `<input type="hidden" id="ans-${i}"></div>`;
                }
                else if(q.t === 'fill' || q.t === 'input' || q.t === 'num') {
                    html += `<input type="text" id="ans-${i}" placeholder="Tapez votre r√©ponse...">`;
                }
                else if(q.t === 'tf') {
                    html += `<div class="tf-grid">
                        <div class="mcq-opt tf-btn" onclick="selOpt(this, ${i}, 'true')">VRAI</div>
                        <div class="mcq-opt tf-btn" onclick="selOpt(this, ${i}, 'false')">FAUX</div>
                        <input type="hidden" id="ans-${i}">
                    </div>`;
                }
                else if(q.t === 'match') {
                    html += `<div style="background:#fff; padding:15px; border:1px solid var(--border); border-radius:8px;">`;
                    const keys = Object.keys(q.p);
                    const vals = Object.values(q.p).sort(() => 0.5 - Math.random());
                    keys.forEach((k, kIdx) => {
                        let opts = `<option value="">...</option>`;
                        vals.forEach(v => opts += `<option value="${v}">${v}</option>`);
                        html += `<div class="match-row"><div class="match-label">${k}</div><select id="match-${i}-${kIdx}">${opts}</select></div>`;
                    });
                    html += `</div>`;
                }

                html += `<div class="feedback" id="feed-${i}"></div>`;
                box.innerHTML = html;
                container.appendChild(box);
            });
        }

        window.selOpt = function(el, qId, val) {
            const parent = el.parentNode;
            Array.from(parent.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(`ans-${qId}`).value = val;
        }

        function checkAndNext() {
            const data = currentExam[currentTrackIdx];
            data.questions.forEach((q, i) => {
                const feed = document.getElementById(`feed-${i}`);
                let isCorrect = false;
                catScores[q.cat].m++;
                maxScore++;

                if(q.t === 'mcq') {
                    if(document.getElementById(`ans-${i}`).value == q.a) isCorrect = true;
                }
                else if(q.t === 'tf') {
                    if(document.getElementById(`ans-${i}`).value === String(q.a)) isCorrect = true;
                }
                else if(q.t === 'fill' || q.t === 'input' || q.t === 'num') {
                    let val = document.getElementById(`ans-${i}`).value.trim().toLowerCase().replace(',','.');
                    let ans = String(q.a).toLowerCase().replace(',','.');
                    if(val === ans || (ans.length > 2 && val.includes(ans))) isCorrect = true;
                    if((ans === "chewing-gums" && val.includes("bonbon")) || (ans==="bonbons" && val.includes("chewing"))) isCorrect = true;
                }
                else if(q.t === 'match') {
                    let all = true;
                    Object.keys(q.p).forEach((k, kIdx) => {
                        if(document.getElementById(`match-${i}-${kIdx}`).value !== q.p[k]) all = false;
                    });
                    if(all) isCorrect = true;
                }

                feed.style.display = 'block';
                if(isCorrect) {
                    score++;
                    catScores[q.cat].g++;
                    feed.innerHTML = "‚úÖ Correct !";
                    feed.className = "feedback good";
                } else {
                    let txt = q.a;
                    if(q.t === 'mcq') txt = q.o[q.a];
                    if(q.t === 'tf') txt = q.a ? "Vrai" : "Faux";
                    if(q.t === 'match') txt = "Voir correspondances";
                    
                    feed.innerHTML = `‚ùå Faux. R√©ponse : <strong>${txt}</strong>`;
                    if(q.expl) feed.innerHTML += `<br>‚ÑπÔ∏è ${q.expl}`;
                    feed.className = "feedback bad";
                }
            });

            if(currentTrackIdx < 2) {
                document.getElementById('next-btn').innerText = "Chargement piste suivante...";
                setTimeout(() => {
                    document.getElementById('next-btn').innerText = "Valider & Suivant";
                    loadTrack(currentTrackIdx + 1);
                }, 3000);
            } else {
                finishExam();
            }
        }

        function finishExam() {
            document.getElementById('exam-ui').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            const totalTime = Math.floor((new Date() - startTime)/1000);
            const m = Math.floor(totalTime/60);
            const s = totalTime%60;
            const avg = Math.round(totalTime/3);
            const perc = Math.round((score/maxScore)*100);

            let weak = "Aucun";
            let minP = 101;
            const labels = {'global':'Compr√©hension Globale', 'detail':'D√©tails', 'num':'Chiffres'};
            
            for(let k in catScores) {
                if(catScores[k].m > 0) {
                    let p = (catScores[k].g / catScores[k].m) * 100;
                    if(p < minP) { minP = p; weak = labels[k]; }
                }
            }

            document.getElementById('final-score').innerText = `${score}/${maxScore}`;
            document.getElementById('res-time').innerText = `${m}m ${s}s`;
            document.getElementById('res-acc').innerText = `${perc}%`;
            document.getElementById('res-weak').innerText = weak + ` (${Math.round(minP)}%)`;
            document.getElementById('res-avg').innerText = `${avg}s`;

            if(!API_URL.includes("PASTE")) {
                const payload = {
                    app_secret: "IB_FRENCH_2025_SECURE",
                    sheetName: "Listening_Analytics",
                    date: new Date().toLocaleDateString('en-SG'),
                    startTime: startTime.toLocaleTimeString('en-SG'),
                    duration: `${m}m ${s}s`,
                    score: score,
                    total: maxScore,
                    percentage: `${perc}%`,
                    avgTimePerTrack: avg,
                    weakness: weak,
                    catScores: {
                        global: `${catScores.global.g}/${catScores.global.m}`,
                        detail: `${catScores.detail.g}/${catScores.detail.m}`,
                        num: `${catScores.num.g}/${catScores.num.m}`
                    }
                };

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(() => {
                    document.getElementById('api-status').innerText = "‚úÖ R√©sultats sauvegard√©s !";
                    document.getElementById('api-status').style.color = "green";
                });
            }
        }
    </script>
</body>
</html>
