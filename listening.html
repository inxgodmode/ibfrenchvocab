<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá´üá∑ IB Listening: Master Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --primary: #0f172a;
            --accent: #3b82f6;
            --correct: #10b981;
            --wrong: #ef4444;
            --border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding: 20px; }
        
        .container { max-width: 900px; margin: 0 auto; background: var(--card); border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid var(--border); }
        
        /* Header */
        .top-bar { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .timer-badge { background: #334155; padding: 5px 12px; border-radius: 8px; font-family: monospace; font-size: 1.1em; border: 1px solid #475569; }

        /* Audio Player */
        .audio-section { background: #eff6ff; padding: 30px; text-align: center; border-bottom: 1px solid var(--border); }
        audio { width: 100%; max-width: 600px; margin-top: 15px; border-radius: 10px; }
        .track-title { font-size: 1.6em; font-weight: 800; color: #1e3a8a; margin-bottom: 5px; }

        /* Questions */
        .content { padding: 40px; }
        .q-block { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed var(--border); }
        .q-block:last-child { border-bottom: none; }
        
        .q-header { display: flex; gap: 15px; margin-bottom: 15px; }
        .q-num { background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .q-text { font-weight: 700; font-size: 1.15em; line-height: 1.5; }
        .q-tag { font-size: 0.75em; text-transform: uppercase; color: #64748b; font-weight: 600; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; height: fit-content; margin-top: 4px; }

        /* Inputs & Grid */
        input[type="text"] { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1em; box-sizing: border-box; transition: 0.2s; background: #f8fafc; }
        input[type="text"]:focus { border-color: var(--accent); background: white; outline: none; }

        .mcq-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 600px) { .mcq-grid { grid-template-columns: 1fr 1fr; } }
        
        .mcq-opt { padding: 14px 20px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 500; background: white; }
        .mcq-opt:hover { border-color: var(--accent); background: #eff6ff; }
        .mcq-opt.selected { border-color: var(--accent); background: #dbeafe; color: #1e3a8a; font-weight: 700; }
        .mcq-opt.correct { background: #dcfce7 !important; border-color: var(--correct) !important; color: #064e3b; }
        .mcq-opt.wrong { background: #fee2e2 !important; border-color: var(--wrong) !important; color: #7f1d1d; opacity: 0.7; }

        /* True/False */
        .tf-container { display: flex; gap: 15px; }
        .tf-btn { flex: 1; text-align: center; padding: 15px; font-size: 1.1em; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; }
        .tf-btn:hover { background: #f8fafc; }
        .tf-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Matching */
        .match-grid { display: grid; gap: 10px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .match-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; }
        .match-label { font-weight: 600; font-size: 0.95em; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer; }

        /* Footer */
        .footer { padding: 25px 40px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn { background: var(--accent); color: white; padding: 15px 35px; border-radius: 12px; border: none; font-weight: 700; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); transition: 0.2s; }
        .btn:hover { background: #2563eb; transform: translateY(-2px); }

        .feedback { margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: 600; display: none; }
        .feedback.good { background: #dcfce7; color: #14532d; border: 1px solid #86efac; }
        .feedback.bad { background: #fee2e2; color: #7f1d1d; border: 1px solid #fca5a5; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- INTRO -->
    <div id="intro" class="container" style="text-align:center; padding: 80px 40px;">
        <h1 style="font-size: 3em; margin-bottom: 10px;">üéß IB French Listening</h1>
        <p style="color: #64748b; font-size: 1.2em;">Full Exam Simulation ‚Ä¢ B1/B2 Level</p>
        
        <div style="background: #f1f5f9; padding: 30px; border-radius: 15px; margin: 40px auto; max-width: 500px; text-align: left;">
            <p><strong>1. Al√©atoire :</strong> 3 pistes audio choisies au hasard parmi 18.</p>
            <p><strong>2. Complet :</strong> 8 √† 9 questions par piste.</p>
            <p><strong>3. M√©lang√© :</strong> L'ordre des r√©ponses change √† chaque fois.</p>
        </div>
        <button class="btn" onclick="startExam()">COMMENCER LE TEST</button>
    </div>

    <!-- EXAM UI -->
    <div id="exam-ui" class="container hidden">
        <div class="top-bar">
            <span>Piste <span id="track-idx">1</span> / 3</span>
            <div class="timer-badge" id="timer">00:00</div>
        </div>

        <div class="audio-section">
            <div class="track-title" id="track-title">...</div>
            <audio id="player" controls controlsList="nodownload"><source id="audio-src" src="" type="audio/mpeg"></audio>
        </div>

        <div class="content" id="q-container">
            <!-- Questions go here -->
        </div>

        <div class="footer">
            <span id="score-live" style="color:#64748b; font-weight:600;"></span>
            <button class="btn" id="next-btn" onclick="checkAnswers()">V√©rifier & Suivant</button>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="container hidden" style="text-align:center; padding: 50px;">
        <h1 style="color: var(--primary);">R√©sultats</h1>
        <div style="font-size: 5em; font-weight: 900; color: var(--accent); margin: 20px 0;" id="final-score">0/0</div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; background: #f8fafc; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
            <div>‚è±Ô∏è Temps Total: <strong id="res-time"></strong></div>
            <div>üéØ Pr√©cision: <strong id="res-acc"></strong></div>
            <div>üìâ Point Faible: <strong id="res-weak" style="color:var(--wrong)"></strong></div>
            <div>‚ö° Temps/Piste: <strong id="res-avg"></strong></div>
        </div>

        <p id="api-status" style="color:#64748b;">Sauvegarde...</p>
        <button class="btn" style="background:#334155;" onclick="location.reload()">Nouveau Test</button>
    </div>

    <script>
        // ==========================================
        // üìö EXPANDED DATABASE (8-9 Questions each)
        // ==========================================
        const database = [
            {
                title: "1. S√©rie 'Berlin' (Netflix)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/berlin.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "De quelle s√©rie 'Berlin' est-elle le spin-off ?", o: ["Lupin", "La Casa de Papel", "Elite"], a: 1 },
                    { t: 'tf', cat: 'detail', q: "L'histoire se d√©roule apr√®s la mort de Berlin.", a: false, expl: "C'est un pr√©quel (avant)." },
                    { t: 'input', cat: 'detail', q: "Dans quelle ville europ√©enne se passe l'action ?", a: "Paris" },
                    { t: 'num', cat: 'num', q: "Quelle est la valeur du butin (en millions d'euros) ?", a: "44" },
                    { t: 'num', cat: 'num', q: "De combien de villes proviennent les joyaux ?", a: "34" },
                    { t: 'tf', cat: 'global', q: "La s√©rie est plus violente que la s√©rie originale.", a: false, expl: "Elle est moins violente, plus romantique." },
                    { t: 'mcq', cat: 'detail', q: "En combien de temps le braquage doit-il √™tre fait ?", o: ["Une semaine", "Une seule soir√©e", "Trois jours"], a: 1 },
                    { t: 'input', cat: 'num', q: "Quel mois la s√©rie est-elle sortie (2024) ?", a: "janvier" },
                    { t: 'match', cat: 'detail', q: "Associez les √©l√©ments :", p: {"Andr√®s": "Berlin", "Lieu": "Bijouterie", "Genre": "Romantique"} }
                ]
            },
            {
                title: "2. H√¥tel de la Marine",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/constantin_l_hotel_de_la_marine_a_paris.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Sur quelle place se situe le monument ?", o: ["Bastille", "Concorde", "Vend√¥me"], a: 1 },
                    { t: 'input', cat: 'num', q: "En quelle ann√©e a-t-il ouvert au public ?", a: "2021" },
                    { t: 'input', cat: 'num', q: "De quel si√®cle date la construction ?", a: "18" },
                    { t: 'tf', cat: 'detail', q: "Avant la R√©volution, c'√©tait le Minist√®re de la Marine.", a: false, expl: "C'√©tait le Garde-Meuble du Roi." },
                    { t: 'mcq', cat: 'detail', q: "Pourquoi a-t-on nettoy√© les fa√ßades ?", o: ["√Ä cause des graffitis", "√Ä cause de la pollution", "Pour changer la couleur"], a: 1 },
                    { t: 'match', cat: 'detail', q: "Associez les lieux :", p: {"Salle de Bal": "Galerie des Glaces", "Appartements": "Intendant", "Loggia": "Vue sur la place"} },
                    { t: 'tf', cat: 'global', q: "Le narrateur a appr√©ci√© l'audioguide.", a: false, expl: "Il l'a trouv√© g√™nant." },
                    { t: 'mcq', cat: 'detail', q: "Qui recevait des invit√©s dans ce b√¢timent ?", o: ["Le Pr√©sident de la R√©publique", "Napol√©on", "Le Maire"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Quel est l'h√¥tel de luxe situ√© √† c√¥t√© ?", a: "crillon" }
                ]
            },
            {
                title: "3. Le Puy du Fou",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/puy_du_fou.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quel d√©partement se trouve le parc ?", a: "Vend√©e" },
                    { t: 'num', cat: 'num', q: "Quel est le prix du billet adulte (en ‚Ç¨) ?", a: "44" },
                    { t: 'num', cat: 'num', q: "Le parc est ouvert de 9h30 √† ___ h 30.", a: "22" },
                    { t: 'tf', cat: 'detail', q: "Le spectacle 'Le Mime et l'√âtoile' est en couleur.", a: false, expl: "Il est en noir et blanc." },
                    { t: 'match', cat: 'detail', q: "Associez :", p: {"Vikings": "Drakkars", "Verdun": "Tranch√©es", "Signe du Triomphe": "Gladiateurs"} },
                    { t: 'mcq', cat: 'detail', q: "Combien d'oiseaux participent au 'Bal des Oiseaux Fant√¥mes' ?", o: ["Une dizaine", "Une cinquantaine", "Une centaine"], a: 2 },
                    { t: 'tf', cat: 'global', q: "L'√©l√®ve a eu peur pendant le spectacle de Verdun.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Que font les drakkars des Vikings ?", o: ["Ils volent", "Ils surgissent de l'eau", "Ils br√ªlent"], a: 1 }
                ]
            },
            {
                title: "4. Match de Football",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/stephane_un_beau_match_de_foot.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Quelles √©quipes s'affrontaient ?", o: ["PSG vs Bayern", "Manchester City vs Real Madrid", "Chelsea vs Barcelone"], a: 1 },
                    { t: 'num', cat: 'num', q: "Quelle √©tait la date du match (jour et mois) ?", a: "26 avril" },
                    { t: 'mcq', cat: 'detail', q: "√Ä quel stade de la comp√©tition ?", o: ["Finale", "Demi-finale", "Match de poule"], a: 1 },
                    { t: 'input', cat: 'detail', q: "Quel joueur fran√ßais a marqu√© deux buts ?", a: "Benzema" },
                    { t: 'tf', cat: 'detail', q: "Le match √©tait tr√®s violent avec beaucoup de fautes.", a: false, expl: "Tr√®s peu de fautes." },
                    { t: 'mcq', cat: 'global', q: "Pourquoi le narrateur aime les clubs anglais ?", o: ["Ils jouent vite / Espace", "Ils ont de l'argent", "Ils d√©fendent bien"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Les joueurs couraient beaucoup ensemble (pressing).", a: true },
                    { t: 'input', cat: 'num', q: "Combien de buts Benzema a-t-il marqu√©s ?", a: "2" }
                ]
            },
            {
                title: "5. Souvenirs de Guerre (Caen)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombes_caen.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quelle ville se passe ce souvenir ?", a: "Caen" },
                    { t: 'num', cat: 'num', q: "Quelle diff√©rence d'√¢ge avec sa s≈ìur ?", a: "6" },
                    { t: 'input', cat: 'num', q: "Quel √¢ge avait la narratrice environ ?", a: "6" },
                    { t: 'mcq', cat: 'detail', q: "O√π la m√®re cachait-elle les enfants ?", o: ["Dans une cave", "Contre un mur avec un matelas", "Sous un lit"], a: 1 },
                    { t: 'tf', cat: 'detail', q: "Il y avait des tranch√©es au milieu de la rue.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Comment les bombes tombaient-elles ?", o: ["Par ricochet", "Verticalement", "Par parachute"], a: 0 },
                    { t: 'tf', cat: 'global', q: "La narratrice se rend compte aujourd'hui de la gravit√©.", a: true },
                    { t: 'input', cat: 'detail', q: "Que criaient les gens √† la fin ?", a: "bravo" },
                    { t: 'mcq', cat: 'detail', q: "Que voyaient-ils passer avant de se cacher ?", o: ["Des chars", "Des avions", "Des bateaux"], a: 1 }
                ]
            },
            {
                title: "6. L'Arc de Triomphe Empaquet√©",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/arc_de_triomphe_empaquete_manue.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Qui sont les artistes ?", o: ["Christo et Jeanne-Claude", "Dali et Gala", "Rodin et Claudel"], a: 0 },
                    { t: 'num', cat: 'num', q: "Combien de semaines l'installation a-t-elle dur√© ?", a: "3" },
                    { t: 'tf', cat: 'detail', q: "La Place de l'√âtoile est rest√©e ouverte aux voitures.", a: false, expl: "Ferm√©e √† la circulation." },
                    { t: 'mcq', cat: 'detail', q: "Quelle couleur avait le tissu ?", o: ["Argent√© / Recyclable", "Rouge", "Dor√©"], a: 0 },
                    { t: 'tf', cat: 'global', q: "Les artistes √©taient vivants lors de l'inauguration.", a: false },
                    { t: 'match', cat: 'global', q: "Concept de l'≈ìuvre :", p: {"Cacher": "Pour r√©v√©ler", "√âph√©m√®re": "Urgence", "Mat√©riau": "Recyclable"} },
                    { t: 'input', cat: 'detail', q: "Quelle place a √©t√© ferm√©e ?", a: "√©toile" },
                    { t: 'mcq', cat: 'detail', q: "Comment le monument paraissait-il ?", o: ["Plus grand", "Plus petit", "Invisible"], a: 0 }
                ]
            },
            {
                title: "7. Lac de l'Eychauda",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/lac_de_l_eychauda.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Dans quel massif montagneux sont-ils ?", a: "√©crins" },
                    { t: 'num', cat: 'num', q: "√Ä quelle altitude se trouve le lac ?", a: "2514" },
                    { t: 'mcq', cat: 'detail', q: "D'o√π vient l'eau du lac ?", o: ["D'un glacier", "D'une source", "De la pluie"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Quelle est la couleur de l'eau (adjectif donn√©) ?", a: "laiteux" },
                    { t: 'mcq', cat: 'detail', q: "Qu'ont-ils vu flotter sur l'eau ?", o: ["Des icebergs", "Des bateaux", "Des feuilles"], a: 0 },
                    { t: 'num', cat: 'num', q: "Combien d'heures de marche pour l'atteindre ?", a: "5" },
                    { t: 'num', cat: 'num', q: "Quelle distance totale ont-ils parcourue ?", a: "15" },
                    { t: 'tf', cat: 'global', q: "Il faut partir tard le matin.", a: false, expl: "Partir t√¥t (7h30)." }
                ]
            },
            {
                title: "8. Le Film Wonka",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/wonka.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "De quel auteur vient l'histoire ?", o: ["Roald Dahl", "J.K. Rowling", "Victor Hugo"], a: 0 },
                    { t: 'input', cat: 'detail', q: "M√©tier de Wonka (autre que chocolatier) ?", a: "magicien" },
                    { t: 'input', cat: 'detail', q: "Qui joue le r√¥le principal ?", a: "Chalamet" },
                    { t: 'mcq', cat: 'detail', q: "Quel genre de film est-ce ?", o: ["Com√©die musicale", "Thriller", "Documentaire"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Acteur / R√¥le :", p: {"Hugh Grant": "Oompa Loompa", "Atkinson": "Pr√™tre", "Colman": "M√©chante"} },
                    { t: 'tf', cat: 'global', q: "Le film est tr√®s sombre.", a: false, expl: "C'est color√© et f√©√©rique." },
                    { t: 'mcq', cat: 'detail', q: "Pour quelle r√©compense a-t-il √©t√© nomin√© ?", o: ["Golden Globes", "Oscars", "Cannes"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "La narratrice a vu le film en VF.", a: false, expl: "En version originale." }
                ]
            },
            {
                title: "9. √âpicerie Participative",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fredericparc-naturel-re_gional-de-la-haute-valle_e-de-chevreuse.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "Pr√©nom du narrateur ?", a: "Fr√©d√©ric" },
                    { t: 'num', cat: 'num', q: "Nombre d'habitants dans le village ?", a: "500" },
                    { t: 'mcq', cat: 'detail', q: "Jour d'ouverture ?", o: ["Samedi", "Dimanche", "Lundi"], a: 0 },
                    { t: 'num', cat: 'num', q: "Ann√©e d'ouverture de l'√©picerie ?", a: "2021" },
                    { t: 'tf', cat: 'detail', q: "Il y a 100 membres.", a: false, expl: "Une vingtaine." },
                    { t: 'mcq', cat: 'global', q: "Quel est l'objectif social ?", o: ["Convivialit√©", "Profit", "√âlections"], a: 0 },
                    { t: 'input', cat: 'detail', q: "D'o√π viennent les produits ?", a: "locaux" },
                    { t: 'tf', cat: 'detail', q: "On peut boire un caf√© sur place.", a: true },
                    { t: 'mcq', cat: 'detail', q: "D√©lai de r√©servation des produits ?", o: ["1 ou 2 semaines", "24 heures", "1 mois"], a: 0 }
                ]
            },
            {
                title: "10. La Picardie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_001.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "O√π se situe la Picardie ?", o: ["Dans le Nord", "Dans le Sud", "√Ä l'Est"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Capitale r√©gionale ?", a: "Amiens" },
                    { t: 'match', cat: 'detail', q: "Lieu / Sp√©cialit√© :", p: {"Chantilly": "For√™t/Ch√¢teau", "Pierrefonds": "Ch√¢teau fort", "Compi√®gne": "Armistice"} },
                    { t: 'input', cat: 'detail', q: "√âcrivain c√©l√®bre d'Amiens ?", a: "Verne" },
                    { t: 'mcq', cat: 'detail', q: "Que sont les 'hortillonnages' ?", o: ["Jardins sur l'eau", "Cath√©drales", "Plats"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "On visite les hortillonnages en voiture.", a: false, expl: "En barque." },
                    { t: 'mcq', cat: 'detail', q: "Quelle ville a un cachet ancien (d√©cor de film) ?", o: ["Senlis", "Beauvais", "Lille"], a: 0 },
                    { t: 'tf', cat: 'global', q: "La r√©gion manque de verdure.", a: false }
                ]
            },
            {
                title: "11. Engagement Associatif",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/josianevoix_002.mp3",
                questions: [
                    { t: 'input', cat: 'num', q: "√Çge de la narratrice ?", a: "58" },
                    { t: 'mcq', cat: 'detail', q: "Son m√©tier ?", o: ["Professeur", "M√©decin", "Comptable"], a: 0 },
                    { t: 'num', cat: 'num', q: "Nombre d'associations ?", a: "2" },
                    { t: 'match', cat: 'detail', q: "R√¥le / Asso :", p: {"Profs": "Tr√©sori√®re", "Voitures": "Secr√©taire"} },
                    { t: 'tf', cat: 'detail', q: "L'asso de voitures publie un bulletin 3 fois par an.", a: true },
                    { t: 'mcq', cat: 'global', q: "Pourquoi s'engage-t-elle ?", o: ["Pour √™tre utile", "Pour l'argent", "Pour voyager"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Que r√©colte-t-elle pour les profs ?", a: "cotisations" },
                    { t: 'tf', cat: 'global', q: "Elle pense qu'il faut rester repli√© sur soi.", a: false }
                ]
            },
            {
                title: "12. Le Cirque 100% Humain",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/le_cirque.mp3",
                questions: [
                    { t: 'mcq', cat: 'global', q: "Particularit√© du cirque ?", o: ["Pas d'animaux", "Gratuit", "Sous l'eau"], a: 0 },
                    { t: 'input', cat: 'num', q: "Dur√©e du spectacle (heures) ?", a: "2" },
                    { t: 'mcq', cat: 'detail', q: "Lieu du chapiteau ?", o: ["Pelouse de Reuilly", "Champs de Mars", "La D√©fense"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Artiste / Action :", p: {"Trap√©zistes": "Vols", "Jongleurs": "Objets", "Funambules": "Moto sur fil"} },
                    { t: 'num', cat: 'num', q: "Capacit√© max du chapiteau ?", a: "3000" },
                    { t: 'tf', cat: 'detail', q: "Il faisait tr√®s chaud.", a: false, expl: "Froid (janvier)." },
                    { t: 'mcq', cat: 'detail', q: "Qu'est-ce que la 'roue infernale' ?", o: ["Deux roues avec des acrobates", "Une moto", "Un cercle de feu"], a: 0 },
                    { t: 'input', cat: 'num', q: "Prix moyen d'une place (euros) ?", a: "20" }
                ]
            },
            {
                title: "13. France Miniature",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/france_miniatures.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "D√©partement ?", a: "Yvelines" },
                    { t: 'mcq', cat: 'detail', q: "Ville ?", o: ["√âlancourt", "Versailles", "Rambouillet"], a: 0 },
                    { t: 'num', cat: 'num', q: "Prix billet enfant (4-11 ans) ?", a: "21" },
                    { t: 'num', cat: 'num', q: "Prix billet adulte ?", a: "27" },
                    { t: 'num', cat: 'num', q: "Prix parking ?", a: "5" },
                    { t: 'match', cat: 'detail', q: "R√©gion / Monument :", p: {"Nord": "Cath√©drale d'Amiens", "Ouest": "Mont Saint Michel", "Est": "Village Alsacien"} },
                    { t: 'tf', cat: 'global', q: "On peut visiter toute la France en une fois.", a: true },
                    { t: 'mcq', cat: 'detail', q: "Monument parisien cit√© √† la fin ?", o: ["Tour Eiffel", "Louvre", "Sacr√© C≈ìur"], a: 0 }
                ]
            },
            {
                title: "14. La R√©cr√© des 3 Cur√©s",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/recre_des_3_cures.mp3",
                questions: [
                    { t: 'input', cat: 'detail', q: "D√©partement breton ?", a: "Finist√®re" },
                    { t: 'mcq', cat: 'detail', q: "Ouverture ?", o: ["Avril √† Novembre", "Juin √† Ao√ªt", "Toute l'ann√©e"], a: 0 },
                    { t: 'num', cat: 'num', q: "Prix billet adulte ?", a: "23" },
                    { t: 'tf', cat: 'detail', q: "Le parc est payant pour les b√©b√©s.", a: false, expl: "Gratuit -1m." },
                    { t: 'input', cat: 'detail', q: "Nom du grand huit : Le ___.", a: "vertika" },
                    { t: 'match', cat: 'detail', q: "Attraction / Type :", p: {"Niagara": "Bou√©e", "Galion": "Bateau pirate", "Tuf Tuf": "Tracteurs"} },
                    { t: 'tf', cat: 'detail', q: "Le parking est payant.", a: false },
                    { t: 'mcq', cat: 'detail', q: "Comment faire le tour du parc ?", o: ["Petit train", "H√©licopt√®re", "√Ä cheval"], a: 0 }
                ]
            },
            {
                title: "15. Voyage F1 en Italie",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/site-170424-melyne-audio-italie.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Premi√®re ville visit√©e ?", o: ["Milan", "Rome", "Turin"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Ville du Grand Prix ?", a: "Monza" },
                    { t: 'input', cat: 'detail', q: "Lac visit√© ?", a: "C√¥me" },
                    { t: 'tf', cat: 'global', q: "C'est un voyage improvis√©.", a: false, expl: "Bien planifi√©." },
                    { t: 'mcq', cat: 'detail', q: "Visite √† Milan ?", o: ["Cath√©drale (Duomo)", "Stade", "Op√©ra"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Elles vont manger dans des fast-foods.", a: false },
                    { t: 'mcq', cat: 'global', q: "Sentiment de la narratrice ?", o: ["Impatience / Excitation", "Peur", "Ennui"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Avec qui part-elle ?", a: "amie" }
                ]
            },
            {
                title: "16. Spectacle au Panth√©on",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/pantheon_manue.mp3",
                questions: [
                    { t: 'input', cat: 'num', q: "Nombre de femmes ?", a: "60" },
                    { t: 'fill', cat: 'detail', q: "Ville partenaire : ___.", a: "colombes" },
                    { t: 'mcq', cat: 'global', q: "Forme du spectacle ?", o: ["D√©ambulation", "Assis", "Virtuel"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Toutes √©taient professionnelles.", a: false },
                    { t: 'match', cat: 'detail', q: "√âl√©ment / Artiste :", p: {"Danse": "Chor√©graphe pro", "Audio": "Podcasts", "Chant": "Com√©diennes"} },
                    { t: 'input', cat: 'detail', q: "C√©l√©brit√© honor√©e ?", a: "Baker" },
                    { t: 'num', cat: 'num', q: "Dur√©e du projet (ans) ?", a: "1" },
                    { t: 'tf', cat: 'global', q: "Le but : questionner la place de la femme.", a: true }
                ]
            },
            {
                title: "17. Bombardement (8 Mars 1944)",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/bombardement_8_mars_44.mp3",
                questions: [
                    { t: 'mcq', cat: 'detail', q: "Destination de la narratrice ?", o: ["La poste", "La gare", "L'√©cole"], a: 0 },
                    { t: 'fill', cat: 'detail', q: "Contenu du colis : ___.", a: "volaille" },
                    { t: 'mcq', cat: 'detail', q: "Bruit entendu ?", o: ["Sir√®nes", "Musique", "Tonnerre"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Elle est rentr√©e chez elle tout de suite.", a: false, expl: "Cach√©e dans une cave." },
                    { t: 'input', cat: 'detail', q: "Transport utilis√© ?", a: "v√©lo" },
                    { t: 'mcq', cat: 'detail', q: "Qui gardait le pont ?", o: ["Police allemande", "R√©sistants", "Am√©ricains"], a: 0 },
                    { t: 'match', cat: 'detail', q: "Description Allemands :", p: {"T√™te": "Casqu√©s", "Ceinture": "Cha√Æne", "Bottes": "Bott√©s"} },
                    { t: 'tf', cat: 'global', q: "Elle avait peur des chiens.", a: true }
                ]
            },
            {
                title: "18. La Lib√©ration",
                url: "https://audio-lingua.ac-versailles.fr/IMG/mp3/fin_de_la_guerre.mp3",
                questions: [
                    { t: 'fill', cat: 'detail', q: "Lib√©rateurs : ___.", a: "am√©ricains" },
                    { t: 'fill', cat: 'detail', q: "Cadeaux lanc√©s : ___.", a: "bonbons" }, // chewing-gums ok
                    { t: 'mcq', cat: 'global', q: "Sentiment dominant ?", o: ["Joie", "Peur", "Col√®re"], a: 0 },
                    { t: 'tf', cat: 'detail', q: "Il restait beaucoup de maisons.", a: false },
                    { t: 'input', cat: 'detail', q: "R√©gion de la grand-m√®re ?", a: "finist√®re" },
                    { t: 'mcq', cat: 'detail', q: "Soldats :", o: ["Debout dans les jeeps", "Cach√©s", "√Ä pied"], a: 0 },
                    { t: 'input', cat: 'detail', q: "Action des gens : Ils ___.", a: "applaudissaient" },
                    { t: 'tf', cat: 'detail', q: "Il y avait beaucoup d'enfants.", a: false }
                ]
            }
        ];

        // ==========================================
        // ‚öôÔ∏è ENGINE
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyfi3EmbvJIG9GZRm4zQU9UnE2fDeL1CX5VGVcPecqu__KnUDdd6rnVOM1t3ODRFX_k/exec";

        let currentExam = [];
        let currentTrackIdx = 0;
        let score = 0;
        let maxScore = 0;
        let catScores = { global: {g:0, m:0}, detail: {g:0, m:0}, num: {g:0, m:0} };
        let startTime;

        function startExam() {
            // Randomly select 3 tracks (Shuffle database -> take first 3)
            currentExam = [...database].sort(() => 0.5 - Math.random()).slice(0, 3);
            
            document.getElementById('intro').classList.add('hidden');
            document.getElementById('exam-ui').classList.remove('hidden');
            startTime = new Date();
            loadTrack(0);
            
            setInterval(() => {
                const diff = Math.floor((new Date() - startTime) / 1000);
                const m = String(Math.floor(diff/60)).padStart(2,'0');
                const s = String(diff%60).padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function loadTrack(idx) {
            currentTrackIdx = idx;
            const data = currentExam[idx];
            document.getElementById('track-title').innerText = data.title;
            document.getElementById('audio-src').src = data.url;
            document.getElementById('player').load();
            document.getElementById('track-idx').innerText = idx + 1;

            const container = document.getElementById('q-container');
            container.innerHTML = '';

            // Shuffle questions for variety inside the track too
            const questions = [...data.questions].sort(() => 0.5 - Math.random());

            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'q-block';
                div.id = `q-${i}`;
                div.dataset.ans = JSON.stringify(q); // Store answer logic

                // Header
                let typeLabel = q.t === 'mcq' ? "QCM" : q.t === 'match' ? "Relier" : q.t === 'tf' ? "Vrai / Faux" : "Compl√©ter";
                let html = `<div class="q-header">
                                <div class="q-num">${i+1}</div>
                                <div>
                                    <div class="q-tag">${typeLabel} ‚Ä¢ ${q.cat}</div>
                                    <div class="q-text">${q.q}</div>
                                </div>
                            </div>`;

                // Render Options
                if (q.t === 'mcq') {
                    html += `<div class="mcq-grid">`;
                    // Shuffle MCQ options
                    const opts = q.o.map((o, idx) => ({val: o, idx: idx})).sort(() => 0.5 - Math.random());
                    opts.forEach(opt => {
                        html += `<div class="mcq-opt" onclick="sel(this, '${i}', '${opt.idx}')">${opt.val}</div>`;
                    });
                    html += `<input type="hidden" id="in-${i}"></div>`;
                }
                else if (q.t === 'tf') {
                    html += `<div class="tf-container">
                        <div class="tf-btn" onclick="sel(this, '${i}', 'true')">VRAI</div>
                        <div class="tf-btn" onclick="sel(this, '${i}', 'false')">FAUX</div>
                        <input type="hidden" id="in-${i}">
                    </div>`;
                }
                else if (q.t === 'match') {
                    html += `<div class="match-grid">`;
                    const keys = Object.keys(q.p);
                    const vals = Object.values(q.p).sort(() => 0.5 - Math.random());
                    keys.forEach((k, kIdx) => {
                        let opts = `<option value="">---</option>`;
                        vals.forEach(v => opts += `<option value="${v}">${v}</option>`);
                        html += `<div class="match-row"><div class="match-label">${k}</div><select id="match-${i}-${kIdx}">${opts}</select></div>`;
                    });
                    html += `</div>`;
                }
                else { // Input/Num
                    html += `<input type="text" id="in-${i}" placeholder="Votre r√©ponse...">`;
                }

                html += `<div class="feedback" id="feed-${i}"></div>`;
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // Selection Logic
        window.sel = function(el, qId, val) {
            const parent = el.parentNode;
            Array.from(parent.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(`in-${qId}`).value = val;
        }

        function checkAnswers() {
            const track = currentExam[currentTrackIdx];
            const qDivs = document.querySelectorAll('.q-block');
            let trackScore = 0;

            qDivs.forEach((div, i) => {
                const q = JSON.parse(div.dataset.ans);
                const feed = document.getElementById(`feed-${i}`);
                let isRight = false;
                
                catScores[q.cat].m++;
                maxScore++;

                if (q.t === 'mcq') {
                    if (document.getElementById(`in-${i}`).value == q.a) isRight = true;
                }
                else if (q.t === 'tf') {
                    if (document.getElementById(`in-${i}`).value === String(q.a)) isRight = true;
                }
                else if (q.t === 'match') {
                    let all = true;
                    Object.keys(q.p).forEach((k, kIdx) => {
                        if(document.getElementById(`match-${i}-${kIdx}`).value !== q.p[k]) all = false;
                    });
                    if (all) isRight = true;
                }
                else {
                    const val = document.getElementById(`in-${i}`).value.trim().toLowerCase();
                    const ans = String(q.a).toLowerCase();
                    if (val.includes(ans) || (val.length > 2 && ans.includes(val))) isRight = true;
                    if (ans === "chewing-gums" && val.includes("bonbon")) isRight = true;
                }

                if (isRight) {
                    score++;
                    catScores[q.cat].g++;
                    feed.innerHTML = "‚úÖ Correct !";
                    feed.className = "feedback good";
                } else {
                    let txt = q.a;
                    if (q.t === 'mcq') txt = q.o[q.a];
                    if (q.t === 'tf') txt = q.a ? "Vrai" : "Faux";
                    if (q.t === 'match') txt = "Voir correspondances";
                    
                    feed.innerHTML = `‚ùå Faux. R√©ponse : <strong>${txt}</strong>`;
                    if(q.expl) feed.innerHTML += `<br>‚ÑπÔ∏è ${q.expl}`;
                    feed.className = "feedback bad";
                }
                feed.style.display = 'block';
            });

            if (currentTrackIdx < 2) {
                document.getElementById('next-btn').innerText = "Piste Suivante...";
                setTimeout(() => {
                    document.getElementById('next-btn').innerText = "V√©rifier & Suivant";
                    loadTrack(currentTrackIdx + 1);
                }, 3000);
            } else {
                finishExam();
            }
        }

        function finishExam() {
            document.getElementById('exam-ui').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            const totalTime = Math.floor((new Date() - startTime)/1000);
            const m = Math.floor(totalTime/60);
            const s = totalTime%60;
            const avg = Math.round(totalTime/3);
            const perc = Math.round((score/maxScore)*100);

            let weak = "Aucun";
            let minP = 101;
            const labels = {'global':'Compr√©hension Globale', 'detail':'D√©tails', 'num':'Chiffres'};
            
            for(let k in catScores) {
                if(catScores[k].m > 0) {
                    let p = (catScores[k].g / catScores[k].m) * 100;
                    if(p < minP) { minP = p; weak = labels[k]; }
                }
            }

            document.getElementById('final-score').innerText = `${score}/${maxScore}`;
            document.getElementById('res-time').innerText = `${m}m ${s}s`;
            document.getElementById('res-acc').innerText = `${perc}%`;
            document.getElementById('res-weak').innerText = weak + ` (${Math.round(minP)}%)`;
            document.getElementById('res-avg').innerText = `${avg}s`;

            if(!API_URL.includes("PASTE")) {
                const payload = {
                    app_secret: "IB_FRENCH_2025_SECURE",
                    sheetName: "Listening_Analytics",
                    date: new Date().toLocaleDateString('en-SG'),
                    startTime: startTime.toLocaleTimeString('en-SG'),
                    duration: `${m}m ${s}s`,
                    score: score,
                    total: maxScore,
                    percentage: `${perc}%`,
                    avgTimePerTrack: avg,
                    weakness: weak,
                    catScores: {
                        global: `${catScores.global.g}/${catScores.global.m}`,
                        detail: `${catScores.detail.g}/${catScores.detail.m}`,
                        num: `${catScores.num.g}/${catScores.num.m}`
                    }
                };

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(() => {
                    document.getElementById('api-status').innerText = "‚úÖ R√©sultats sauvegard√©s !";
                    document.getElementById('api-status').style.color = "green";
                });
            }
        }
    </script>
</body>
</html>
